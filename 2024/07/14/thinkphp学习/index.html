<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>thinkphp学习 | Sherlock</title><meta name="keywords" content="php"><meta name="author" content="Sherlock"><meta name="copyright" content="Sherlock"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="thinkphp学习"><meta name="application-name" content="thinkphp学习"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="thinkphp学习"><meta property="og:url" content="http://example.com/2024/07/14/thinkphp%E5%AD%A6%E4%B9%A0/index.html"><meta property="og:site_name" content="Sherlock"><meta property="og:description" content="引用thinkPHP8.0安装与避坑 ThinPHP官方手册 安装thinphp8.012345678910111213&amp;lt;!--1、访问网址下载安装composer--&amp;gt;https:&amp;#x2F;&amp;#x2F;getcomposer.org&amp;#x2F;Composer-Setup.exe&amp;lt;!--2、配置镜像源防止乱"><meta property="og:locale" content="en"><meta property="og:image" content="http://example.com/img/Sherlock.jpg"><meta property="article:author" content="Sherlock"><meta property="article:tag" content="智商不够,勤勉来凑;眼神不太好"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://example.com/img/Sherlock.jpg"><meta name="description" content="引用thinkPHP8.0安装与避坑 ThinPHP官方手册 安装thinphp8.012345678910111213&amp;lt;!--1、访问网址下载安装composer--&amp;gt;https:&amp;#x2F;&amp;#x2F;getcomposer.org&amp;#x2F;Composer-Setup.exe&amp;lt;!--2、配置镜像源防止乱"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/2024/07/14/thinkphp%E5%AD%A6%E4%B9%A0/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🔍 分享与热心帮助","🤝 喜欢团结协作","🏃 脚踏实地行动派","💢 壮汉人狠话不多"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"Author: Sherlock","link":"Link: ","source":"Source: Sherlock","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source.","copySuccess":"Copy success, copy and reprint please mark the address of this article"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Sherlock',
  title: 'thinkphp学习',
  postAI: '',
  pageFillDescription: '引用, 安装thinphp8.0, 基础, 目录结构, 单应用模式, 多应用模式, 默认应用文件, 配置, 架构, HTTP请求流程, 入口文件, 应用入口文件, 控制台入口文件, 多应用模式, URL访问, 单应用URL, URL重写, [ Apache ], [ Nginx ], 控制器, 定义, 基础和空控制器, 基础控制器, 空控制器, 数据库, 创建数据库及表, 连接数据库和查询, 连接数据库, PHP获取数据, 数据查询, table方法, 链式查询, 表达式查询, 查询示例, 表前缀之扩展查询, 表前缀, 扩展查询, 添加数据, 单条新增, 多条新增, 更新删除以及save方法, 数据修改, 数据删除, 其他各种查询方式, 字符串条件, field()字段筛选, 常用链式方法, 时间查询, 聚合查询, 子查询, 原生查询, 列字段快捷查询, 条件查询, 事务, 获取器, 高级查询, 索引关联, 拼装查询, 模型, 定义, 定义模型, 模型设置, 新增和删除, 新增操作, 删除操作, 更新, 数据更新, 查询, 模型的查询, 模型的字段设置, 字段设置, 废弃字段, 只读字段, 获取器和修改器, 获取器, 修改器, 搜索器和自动时间戳, 搜索器, 自动时间戳, 软删除和事件, 软删除, 事件, 模型事件定义, 写入事件, 关联模型, 入门, 关联表, 关联查询, 一对一关联查询, hasOne 模式, belongsTo 模式, 一对多关联查询, hasMany 模式, 模型预载入和统计, 预载入, 关联统计, 多对多关联查询, 建立三张表, 权限控制, 路由, 定义, 路由入门, 强制路由, 完全匹配, 路由闭包和变量规则, 闭包, 变量规则, 路由参数.域名.MISS, 参数, 域名, MISS, 路由分组.URL生成, 分组, URL生成, 资源路由, 创建资源, 地址URL, 视图.变量渲染, 视图操作, 表单提交, 请求对象.变量.信息, 请求对象, 请求信息, 请求变量, 请求类型.输出.重定向, 请求类型, 响应输出, 重定向, 中间件, 定义, 定义中间件, 前后置中间件, 中间件操作, 路由中间件, 2. 控制器中间件引用安装与避坑官方手册安装访问网址下载安装配置镜像源防止乱七八糟的网络和仓库拉取无权限问题在网站根目录下进入创建项目解决依赖项报错运行命令查看效果访问查看结果这里有坑不能直接访问这个地址在第三步创建项目时候有报错是正常的因为有依赖项无法安装的问题我安装时候的解释器版本是所以需要切换到项目目录下执行命令解决依赖项无法安装的问题基础目录结构单应用模式默认安装后的目录结构就是单应用目录结构部署目录或者子目录应用目录控制器目录模型目录更多类库目录公共函数文件事件定义文件配置目录应用配置缓存配置控制台配置配置数据库配置文件磁盘配置多语言配置日志配置中间件配置和路由配置配置配置视图配置视图目录路由定义目录路由定义文件目录对外访问目录入口文件快速测试文件用于的重写扩展类库目录应用的运行时目录可写可定制类库目录环境变量示例文件定义文件授权说明文件文件命令行入口文件多应用模式详见官方手册默认应用文件默认安装后目录下会包含下面的文件应用目录默认基础控制器类应用异常定义文件全局公共函数文件全局中间件定义文件服务提供定义文件应用请求对象全局事件定义文件和三个文件是系统默认提供的基础文件位置你可以随意移动但注意要同步调整类的命名空间如果你不需要使用和文件或者要调整类名记得必须同步调整文件中的容器对象绑定配置默认情况下程序出错会显示页面出错请稍候再试这种情况一般是应用部署好后万一出错给用户看的如果我们自己在开发阶段需要开启调试模式来提示具体的错误信息在根目录有一个文件改成也就是去掉点前面环境变量文件然后在配置信息的第一行即可则不开启开启后会如下所示调试模式开启后可以发现右下角会出现调试工具小图标包含了丰富的调试内容具体自点查看架构请求流程对于一个应用来说从用户发起请求到响应输出结束大致的标准请求流程如下载入的自动加载文件实例化系统应用基础类获取应用目录等相关路径信息加载全局的服务提供文件设置容器实例及应用对象实例确保当前容器对象唯一从容器中获取应用类执行应用类的方法启动一个应用获取当前请求对象实例默认为继承保存到容器执行类的初始化方法加载环境变量文件和全局初始化文件加载全局公共文件系统助手函数全局配置文件全局事件定义和全局服务定义判断应用模式调试或者部署模式监听事件注册异常处理服务注册启动注册的服务加载全局中间件定义监听事件执行全局中间件执行路由调度类方法如果开启路由则检查路由缓存加载路由定义监听事件如果开启注解路由则检测注解路由路由检测中间流程很复杂略路由调度对象初始化设置当前请求的控制器和操作名注册路由中间件绑定数据模型设置路由额外参数执行数据自动验证执行路由调度子类的方法返回响应对象获取当前请求的控制器对象实例利用反射机制注册控制器中间件执行控制器方法以及前后置中间件执行当前响应对象的方法输出执行应用对象的方法善后监听事件执行中间件的回调写入当前请求的日志信息入口文件采用单一入口模式进行项目部署和访问一个应用都有一个统一但不一定是唯一的入口如果采用自动多应用部署的话一个入口文件还可以自动对应多个应用应用入口文件默认的应用入口文件位于如果你没有特殊的自定义需求无需对入口文件做任何的更改入口文件位置的设计是为了让应用部署更安全请尽量遵循目录为唯一的可访问目录其他的文件都可以放到非访问目录下面控制台入口文件除了应用入口文件外系统还提供了一个控制台入口文件即位于项目根目录的文件控制台入口文件用于执行控制台指令例如系统内置了一些常用的控制台指令如果你安装了额外的扩展也会增加相应的控制台指令都是通过该入口文件执行的多应用模式详见官方手册访问单应用控制器操作参数值注意这里服务器启动是的内置服务器下节课会探讨外置服务器结构分析就是我们的是入口文件带上控制器是中的这个名称也就是类名操作是类里面的方法名比如默认方法普通方法默认方法可以省略会直接方法其他普通方法需要键入方法名默认执行操作完整路径普通方法必须完整路径系统默认自带的方法是针对后续路由的在路由文件设置过导致无效我们在中将路由关闭执行默认参数值修改参数值参数不够直观尤其多参数的时候也是支持传统方案的问号键值对重写可以通过重写隐藏应用的入口文件也可以是其它的入口文件但重写通常只能设置一个入口文件下面是相关服务器的配置参考配置文件中加载了模块将改为把下面的内容保存为文件放到应用入口文件的同级目录下在低版本中是不支持的但是可以通过在中配置转发规则实现省略部分代码其实内部是转发到了提供的兼容利用这种方式可以解决其他不支持的服务器环境外置服务器比如省略了入口文件则出现如下问题查看手册根据它重写的修改方案需要修改最后一行替换成下面一行控制器定义控制器顾名思义中的即逻辑控制定义默认在下编写对应的控制器类文件如果想改默认目录在中进行修改访问控制器层名称类名和文件名大小写保持一致并采用驼峰式首字母大写用户登陆成功类创建两个方法默认和访问如下那么如果创建的是双字母组合比如访问如下基础和空控制器基础控制器一般来说创建控制器后推荐继承基础控制器来获得更多的功能方法基础控制器仅仅提供了控制器验证功能并注入了和返回实际路径返回当前方法名空控制器空控制器一般用于载入不存在的控制器时进行错误提示当前控制器不存在数据库创建数据库及表我这边使用软件配合进行创建的这边我就不详细说明了连接数据库和查询连接数据库我们可以在配置文件中设置与数据库的连接信息如果是一般性数据库连接在配置区设置即可如果是本地测试它会优先读取配置然后再读取的配置文件部署服务器请禁用我如果禁用了配置则会读取数据库连接的默认配置数据库连接配置信息数据库类型服务器地址数据库名用户名密码端口获取数据我们暂时没有详细学习此类语法可以简单用一些了解一下即可引入数据库类连接表查询输出数据数据查询方法类旗下有一个静态调用的方法参数为完整的表名前缀都不能省略如果希望只查询一条数据可以使用方法需指定条件通过查询指定的数据方法查询结果不存在返回否则返回结果数组想要了解执行的原生是什么可以注释掉直接通过查看使用方法也可以查询一条数据但在没有数据时返回一个空数组没有数据返回空数组使用方法同样可以查询一条数据在没有数据时抛出一个异常没有数据抛出异常想要获取多列数据可以使用方法查询所有数据方法默认返回对象的数据集可以通过方法转换成数组用中断函数来检测返回值转换成数组多列数据也可以参与方法的筛选多列筛选链式查询我们发现通过指向符号多次连续调用方法称为链式查询当时返回查询对象即可连缀数据库对应的方法当返回查询对象时就可以继续调用链式方法也是链式方法而被调用后依旧返回可以再次链式调用在手册数据库查询构造器链式操作可以了解所有可链式的方法等直到遇到或返回数组或数据集时结束查询表达式查询查询表达式支持大部分常用的语句语法格式如下字段名查询表达式查询条件所有的表达式查阅手册查询表达式中的表格即可这里列出几个意思一下表达式含义快捷方式等于小于等于某个时间表达式查询模糊查询非查询查询示例条件判断类的大于的查询大于的数据模糊查询姓王的查询姓王的用户王快捷方式王区间查询根据区间查询支持语义更好一点快捷查询两种均可支持和一样支持快捷方式和一样和查询或快捷方式和查询自定义片段查询自定义快捷查询表前缀之扩展查询表前缀一般来说为了保持表名统一性和防止冲突都会给表加上一个前缀以下划线结束比如这里的就是表前缀所有我们修改中表名然后刷新程序报错当然你可以传递但没必要首先我们可以来配置统一前缀在文件中添加如果部署环境中设置然后使用方法即可此时表名的前缀可以省略扩展查询通过方法可以查询指定字段的值单个没有数据返回方法查询单个列值通过方法可以查询指定列的值多个没有数据返回空数组方法查询多个列值通过作为索引当大量数据需要批处理时比如给所有用户更新数据就不能一次性全取出来一批一批的来批量处理通过获取最后的语句发现用的是另一种处理大量数据游标查询为了解决内存开销每次读取一行并返回到下一行再读取批量处理生成器添加数据单条新增使用方法可以向数据表添加一条数据更多的字段采用默认数据张麻子男单条新增成功返回如果想强行新增抛弃不存在的字段数据则使用方法忽略异常数据马邦德男我脸上没有麻子单条新增成功返回如果我们采用的数据库是可以支持写入和写入的区别前者表示表中存在主键相同则报错后者则修改新增数据时主键冲突时直接修改这条记录使用方法可以在新增成功后返回当前数据返回自增多条新增使用方法可以批量新增数据但要保持数组结构一致数据林克男先收集个呀哈哈普尔亚女我先来个返老还童再快速长大方法也支持写入如果添加数据量大可以通过方法限制添加数量更新删除以及方法数据修改使用方法来修改数据修改成功返回影响行数没有修改返回修改的数据王三狗执行修改并返回如果修改数据包含了主键信息比如那么可以省略掉条件修改的数据王三狗执行修改并返回如果想让一些字段修改时执行函数操作可以使用方法实现让字段内的英文大写如果要自增自减某个字段可以使用方法并支持自定义步长修改时让自增和自减默认要去掉里面字段的修改不然冲突派生自字段延迟执行毫秒使用来设置每个字段的特殊需求灵活且清晰使用更加清晰灵活方法是一个通用方法可以自行判断是新增还是修改更新数据包含主键即修改否则新增数据删除极简删除可以根据主键直接删除删除成功返回影响行数否则根据主键删除根据主键还可以删除多条记录根据主键删除多条正常情况下通过方法来删除条件删除其他各种查询方式字符串条件可以直接写入多条件多条件字符串女包含变量的多条件查询变量女预处理机制字段筛选使用方法可以指定要查询的字段字段筛选使用方法给指定的字段设置别名字段别名在方法里可以直接给字段设置函数直接函数推荐使用方法中字段排除可以屏蔽掉想要不显示的字段排除字段使用方法在新增时验证字段的合法性排除新增字段常用链式方法使用方法给数据库起一个别名给数据库起个别名起别名最主要是和另一张表进行关联这里看手册好了没表测试使用方法限制获取输出数据的个数显示前条分页模式即传递两个参数比如从第条开始显示条从第个位置也就是第条开始显示条查询第一页数据至条使用方法可以指定排序方式没有指定第二参数默认按倒序排列支持数组的方式对多个字段进行排序按多个字段规则排序支持方法可以传入函数和前面各类一样不再赘述使用方法给性别不同的人进行字段的总和统计统计性别的年龄总和使用分组之后再使用进行筛选统计性别的年龄总和筛选大于的时间查询可以使用来筛选匹配时间的数据传统时间筛选快捷方式使用快捷方式查询默认是可以省略区间查询快捷方式区间查询包含使用查询今年的数据去年的数据和某一年的数据查询今年查询去年查询某一年使用查询当月的数据上月的数据和某一个月的数据使用查询今天的数据昨天的数据和某一个天的数据查询指定时间的数据比如两小时内的两小时内的查询两个时间字段时间有效期的数据比如活动开始到结束的期间比如创建两个字段注册后分别写入对应时间表明它的有效期直接这么写不太好理解看手册的另一种普通写法很容易理解实战中字段丰富的时候再演示聚合查询使用方法可以求出所查询数据的数量获取记录数可设置指定比如有空值的不会计算数量值不计数使用方法求出所查询数据字段的最大值求最大年龄如果方法求出的值不是数值则通过第二参数强制转换如果最大值不是数值关闭强制转换使用方法求出所查询数据字段的最小值也可以强制转换求最小值使用方法求出所查询数据字段的平均值求平均值使用方法求出所查询数据字段的总和求总和子查询使用方法传递参数时可以设置不执行直接返回语句子查询语句使用方法也是返回语句不需要再执行且有括号第二种子查询结合以上方法我们实现一个子查询子查询样式使用闭包的方式执行子查询采用闭包构建子查询原生查询使用方法进行原生查询适用于读取操作错误返回原生使用方法进行原生更新写入等错误返回原生更新写入快快快来救我列字段快捷查询之前用过诸如等等快捷查询所有快捷查询列表的手册位置数据库查询构造器高级查询中找到快捷查询表格方法比较两个字段的值符合的就筛选出来字段比较大于如果是等于判断可以简化方法查询某个字段的值注意是字段名获取所有性别为男男获取名字叫王二狗的信息王二狗方法查询某个字段的值注意只能查询一条不需要单条数据王二狗方法通过查询得到某个指定字段的单一值查询单条并返回单列找出王二狗的年龄王二狗条件查询可以通过条件判断执行闭包里的分支查询条件判断满足条件执行这段不满足条件执行这段第一个参数是条件如果该条件为则执行第一个匿名函数否则执行第二个匿名函数事务数据库的表引擎需要是才可以使用如果不是调整即可事务处理需要执行多个查询数据是关联恒定的如果成功一条查询改变了数据而后一条失败则前面的数据回滚比如银行取钱银行扣了但入口被卡住你没拿到这时需要事务处理系统提供了两种事务处理的方式第一种是自动处理出错自动回滚出现异常回滚手动处理基本和原生处理类似可以自行输出错误信息启动事务提交事务执行失败回滚获取器获取器的意思就是将数据的字段进行转换处理再进行操作比如在获取数据列表的时候将获取到的详情字段全部大写获取器改变字段值不处理也是支持字段的具体参考手册查询构造器获取器高级查询索引关联方法的数组查询性别男年龄大于岁常规做法男索引数组方式二维数组返回的是一条并列关系男如果是等于可以直接用关联数组一维男两种模式结合起来男搜索条件独立管理这里号写全男拼装查询使用或来实现条件的高级查询支持多个连缀和拼装查询王拼装返回的王王索引数组方式可以在进行多个字段进行查询索引数组拼装女我拼装返回的女我条件字符串复杂组装比如使用了就使用方法拼装男拼装返回的男如果有多个并需要控制优先级那么可以在需要的部分加上中括号下面的代码无法控制优先级男我外加一个中括号拼装返回的男我推荐用变量代替男如果条件中有多次出现一个字段并且需要来左右筛选可以用多条件重复字段选项王女拼装返回的王女模型定义定义模型为了避免被前面课程中控制器的类名干扰删除或改名都行目前不存在任何地方的了定义一个和数据库表相匹配的模型可在应用目录下创建文件夹模型会自动对应数据表并且有一套自己的命名规则模型类需要去除表前缀采用驼峰式命名并且首字母大写表名表名在控制器段创建一个任意名称的类当然有语义更好但为了教学理解起名为注意类名不限制模型设置系统会自动识别模型类名对应表名对应表不含前缀但如果你的模型类名不是按照规则对应表名则需要通过成员字段去设置设置表名使用时指定表时需要完整的表名系统也会默认为你的主键名如果不是则需要设置设置主键模型支持初始化功能需要设置静态方法并只在第一次实例化的时候执行且只执行一次初始化新增和删除新增操作用模型新增数据首先要实例化模型开发工具会补全非集成工具别忘了手册这里括号是工具补全的都可以使用实例化的方式添加一条数据并使用方法进行保存注意使用模型时会自动给时间字段要有该字段写入当前时间李白男床前明月光好诗成功返回失败抛异常其它看手册也可以通过传递数据数组的方式来新增数据杜甫男一行白鹭上青天好诗使用方法允许要写入的字段其它字段就无法写入了蒲松龄男十里平湖霜满天好诗模型新增也提供了方法来实现新增蒲松龄男十里平湖霜满天好诗当新增成功后使用可以获得自增主键需是使用方法可以批量新增数据返回批量新增的数组赵六男钱七男我很有钱排行老七使用静态方法来创建要新增的数据李逍遥男我是一代主角参数是新增数据数组必选参数是允许写入的字段可选参数为是否写入可选默认为写入删除操作使用方法通过主键查询到想要删除的数据然后再通过方法将数据删除返回布尔值根据主键值删除数据也可以使用静态方法调用方法通过主键删除数据单条删除批量删除条件删除返回删除的条目数方法使用闭包的方式进行删除闭包模式更新数据更新使用方法获取数据然后通过方法保存修改返回布尔值我是一代主角通过方法结合方法的查询条件获取的数据进行修改李逍遥我想做二代主角方法只会更新变化的数据如果提交的修改数据没有变化则不更新但如果你想强制更新数据即使数据一样那么可以使用方法如何验证被强制了查看字段是否更新了执行函数的方式同样在这里有效关于验证过滤后续学习再说手册中模型更新里也有说明通过方法可以批量修改数据返回被修改的数据集合女女女使用静态方法更新返回的是对象实例男放在后面返回数据不含男限制更新的内容只允许被修改男可笑的人查询其实和数据库的查询大差不差模型的查询模型的绝大部分语法基本都来自于的查询在手册模型查询中可以查阅这里就演示几个常用的意思一下单个和多个也可以使用方法进行条件筛选查询数据模型方法也可以使用等连缀查询和数据库查询方式一样模型支持聚合查询等模型也支持大量的快捷方式这里演示一个王模型的字段设置字段设置模型的数据字段和表字段是对应关系默认会自动获取包括字段的类型自动获取会导致增加一次查询如果在模型中配置字段信息会减少内存开销可以在模型设置字段明确定义字段信息字段需要对应表写完整字段类型的定义可以使用类型或者数据库的字段类型都可以以便自动绑定类型设置字段信息需要写完整的数据表字段设置模型字段只能对模型有效对于查询无法作用要让模型和查询都支持字段类型设置分三步把上面的先注释掉在开启缓存字段开启字段缓存在根目录命令行执行命令废弃字段由于历史遗留问题我们不再想使用某些字段可以在模型里设置设置后我们在查询和写入时将忽略这些字段设置废弃字段只读字段只读字段用来保护某些特殊的字段值不被更改这个字段的值一旦写入就无法更改设置只读字段然后在控制器端进行修改测试修改查看只读字段李逍遥可笑获取器和修改器获取器获取器的作用是对模型实例的数据做出自动处理一个获取器对应模型的一个特殊方法该方法为方法名的命名规范为举个例子数据库表示状态字段采用的是数值而页面上我们需要输出字段希望是中文就可以使用获取器在模型端我创建一个对外的方法如下获取器改变字段的值删除冻结正常待审核控制器端正常输出数据如果你定义了获取器并且想获取原始值可以使用方法使用在控制器端实现动态获取器比如让年龄岁可以传入参数二获得所有数据方便数据获取和判断修改器模型修改器的作用就是对模型设置对象的值进行处理比如我们要新增数据的时候对数据就行格式化过滤转换等处理模型修改器的命名规则为我们要设置一个新增规定输入的年龄都自动岁修改器如下修改器写入时改变字段的值酒剑仙男我是隐藏主角除了新增会调用修改器修改更新也会触发修改器模型修改器只对模型方法有效调用数据库的方法是无效的比如搜索器和自动时间戳搜索器搜索器是用于封装字段或搜索标识的查询表达式类似查询范围一个搜索器对应模型的一个特殊方法该方法为方法名的命名规范为举个例子我们要封装一个字段的模糊查询然后封装一个时间限定查询在模型端我创建两个对外的方法如下搜索器模糊查找姓名搜索器限定时间在控制器端通过方法实现模型搜索器的调用李中第一个数组参数限定搜索器的字段第二个则是表达式值如果想在搜索器查询的基础上再增加查询条件直接使用链式查询即可女在获取器和修改器都有一个参数它的作用是什么搜索器模糊查找姓名按年龄排序自动时间戳如果你想全局开启在中设置为此时写入操作时会自动对和进行写入如果你只想设置某一个模型开启需要设置特有字段自动时间戳只能在模型下有效数据库方法不可以使用如果创建和修改时间戳不是默认定义的也可以自定义如果业务中只需要而不需要可以关闭它也可以动态实现不修改具体如下软删除和事件软删除软删除也称为逻辑删除只是给数据标记已删除的状态不是真实的物理删除为何要对数据进行软删除因为真实的物理删除删了就没了呀在模型端设置软删除的功能引入它是会自动引入开启软删除创建字段并设置默认为默认设置的是如果你想更改这个默认值可以设置由于我们之前演示过字段缓存会导致无法软删除你可以删除字段缓存或者重新更新下删除分为两种和具体如下软删除真实删除软删除真实删除软删除后数据库内的数据只是被标记了删除时间而搜索数据时会自动屏蔽这些数据在开启软删除功能的前提下使用方法取消屏蔽软删除的数据如果只想查询被软删除的数据使用方法即可如果想让某一条被软删除的数据恢复到正常数据可以使用方法如果要将软删除后的数据库真实的物理删除需要先将它恢复再真实删除事件模型事件是指在进行模型的查询和写入操作的时候触发的操作行为模型事件只在调用模型的方法生效使用查询构造器操作是无效的模型支持如下事件事件描述事件方法名查询后新增前新增后更新前更新后写入前写入后删除前删除后恢复前恢复后注册的回调方法支持传入一个参数当前的模型对象实例但支持依赖注入的方式增加额外参数如果事件方法中返回或者抛出异常的话则不会继续执行后续的操作模型事件定义最简单的方式是在模型类里面定义静态方法来定义模型的相关事件响应参数是当前的模型对象实例支持使用依赖注入传入更多的参数写入事件和事件会在新增操作和更新操作都会触发具体的触发顺序执行如果事件没有返回那么继续执行执行新增或更新操作或新增或更新执行成功执行注意模型的新增或更新是自动判断的关联模型入门关联表我们已经有了一张表主键为我们需要一个附属表来进行关联附属表建立两个字段和外键是关联查询关联模型顾名思义就是将表与表之间进行关联和对象化更高效的操作数据创建模型和模型均为空模型如果已有改名备份起来模型端需要关联具体方式如下一对一关联参数关联的表模型参数默认为外键创建一个控制器用于测试输出主表访问关联从表一对一关联查询模式模式适合主表关联附表具体设置方式如下定义与模型的一对一关系返回模型实例关联模型必须关联的模型名或者类名外键默认的外键规则是当前模型名不含命名空间下同例如主键当前模型主键默认会自动获取也可以指定传入我们了解了表与表关联后实现的查询方案主表访问关联从表使用方法可以设置关联修改通过主表修改附表字段的值和蛇妖玩耍属性方式可以修改数据方法方式可以新增数据新增附表数据先找到主表数据然后通过方法实现新增不喜欢吃青椒模式模式适合附表关联主表具体设置方式如下注意此时绑定需要模型创建方法执行关联模型外键关联主键查询方式和主附查询方式一致附表访问关联主表使用也能模拟来进行查询这样就可以不用在模型进行设置注意参数的是方法名不是模型名闭包方式一对多关联查询模式模式适合主表关联附表实现一对多查询具体设置方式如下由于是一对多需要在附表添加多个相同的数据测试关联模型外键主键查询方案和一对一相同主表一对多使用方法模式可以进一步进行数据的筛选主表一对多进一步筛选数据保留实际顺序的下标进一步筛选数据下标重新从开始需要连缀使用方法查询关联附表的主表内容比如大于等于条的主表记录参数是方法名使用方法查询附表中可见兴趣的主表记录查询附表中为的兴趣关联主表的记录使用和进行关联新增和批量关联新增方法如下主表数据新增附表关联数据测试喜欢批量新增测试喜欢测试喜欢使用方法可以删除主表内容时将附表关联的内容全部删除删除主数据并清空关联附表数据特别注意由于外键约束设置问题默认情况下关联操作可能会导致错误解决方案在表中设置外键删除和修改时为即可详细阅读如下模型预载入和统计预载入在普通的关联查询下我们循环数据列表会执行次查询主表三条记录遍历附表上面继续采用普通关联查询的构建方式打开调试工具会得到四次查询如果采用关联预载入的方式将会减少到两次也就是起步一次循环一次查看显示结构关联预载入减少了查询次数提高了性能但是不支持多次调用如果你有主表关联了多个附表都想要进行预载入可以传入多个模型方法即可上面显示结构中主表和附表的字段已经非常多了需要对两个表字段进行筛略注意对应另一个是注意关联字段一定要包含外键否则空或者简单些直接字段隐藏主表加上隐藏附表除了还有对应的方法还有一些预载入缓存延迟预载入可以参考手册关联统计使用方法可以统计主表关联附表的个数输出用统计这三条数据关联的附表数据的个数关联统计的输出采用关联方法名这种结构输出不单单支持还有如下统计方法均可支持等除了不需要指定字段其它均需要指定统计字段统计附表关联字段的累加和对于输出的属性可以自定义多对多关联查询建立三张表复习一下一对一一个用户对应一个用户档案资料是一对一关联复习一下一对多一篇文章对应多个评论是一对多关联多对多怎么理解分解来看一个用户对应多个角色而一个角色对应多个用户那么这种对应关系就是多对多关系最经典的应用就是权限控制用户表角色表中间表表包含了和表的关联多对多模式关联模型中间表外键关联键这里继承的是它本身也继承了是中间表基类多对多专用模型权限控制在控制器段我们查询一下为的用户并关联查询它的权限获取一个用户张三获取这个用户所有角色当我们要给一个用户创建一个角色时用到多对多关联新增如果这个角色不存在则会给角色表增加一条信息并且会在中间表关联角色和用户测试管理专员也支持批量一般来说上面的这种新增方式用于初始化角色比较合适但是很多情况下角色权限是初始化好的只需要添加中间表而不是角色表那么我们真正需要就是通过用户表新增到中间表关联即可给张三添加一个已经存在的角色直接传角色即可或或如果有其它字段可以通过中括号添加测试详情除了新增还有直接删除中间表数据的方法取消掉张三的所有这里的值是角色的不是中间表路由定义路由入门路由的作用就是让地址更加的规范和优雅或者说更加简洁设置路由对的检测验证等一系列操作提供了极大的便利性路由是默认开启的如果想要关闭路由在配置是否启用路由路由的配置文件在中定义文件在我们还回到最初的控制器创建一个带参数的方法此时我们在根目录下的里配置路由参数参数参数控制器方法访问地址方法是默认请求是即任何请求类型均可第三参数可以限制所有的请求方式均有快捷方式比如等具体查看手册路由路由定义快捷方式无须第三参数了在路由的规则表达式中有多种地址的配置规则静态路由带一个参数带两个参数带可选参数一般在后面全动态地址不限定可以是后面也可以动态正则规则完全匹配强制路由目前来说路由访问模式和访问模式都可以使用但我们强制路由访问开始强制路由需要在里面进行配置是否强制使用路由首页也必须设置路由完全匹配规则匹配检测的时候默认只是对从头开始匹配只要地址开头包含了定义的路由规则就会匹配成功如果希望进行完全匹配可以在路由表达式最后使用符号例如这样定义后会匹配成功而则不会匹配成功如果是采用方式定义的话则两种方式的访问都可以匹配成功如果需要全局进行完全匹配可以在路由配置文件中设置开启路由完全匹配开启全局完全匹配后如果需要对某个路由关闭完全匹配可以使用路由闭包和变量规则闭包闭包支持我们可以通过直接执行而不需要通过控制器和方法闭包闭包支持也可以传递参数和动态规则带参数闭包如果不带那么地址变量规则系统默认的路由变量规则为即字母数字中文和下划线如果你想更改默认的匹配规则可以修改配置默认的路由变量规则如果我们需要对于具体的变量进行单独的规则设置则需要通过方法将方法里的传值严格限制必须只能是数字正则规则限定为数字多个参数如果让指定的参数统一限定为数字比如和也就是全局设置在顶部设置不喜欢斜杠怎么办能换成减号吗可以的支持替换斜杠支持组合变量方式路由参数域名参数设置路由的时候可以设置相关方法进行从而实施匹配检测和行为执行方法作用是检测后缀比如我们强制所有后缀为方法作用是检测是否为请求结合强制如下如果想让全局统一配置后缀的话可以在中设置具体值可以是单个或多个后缀也可以是空字符串任意后缀禁止后缀伪静态后缀方法作用是禁止某些后缀的使用使用后直接报错可以将设置为空测试方法作用是检测当前的域名是否匹配完整域名和子域名均可还有检测额外参数检测追加额外参数统一管理检测可参考手册域名如果想限定的某个域名下生效的路由比如可以通过域名闭包方式或路由域名也支持等路由参数方法的操作全局类似开启强制路由功能匹配不到相应规则时自动跳转到闭包模式路由分组生成分组路由分组即将相同前缀的路由合并分组这样可以简化路由定义提高匹配效率使用方法来进行分组路由的注册也可以省去第一参数让分组路由更灵活一些使用方法可以省略掉分组地址里的控制器生成使用助手函数来生成定义好的路由地址放在在控制器使用静态不带参数的控制器段获取动态带参数的控制器段获取参数一和路由的的参数二是一致的可以通过方法复刻控制器段获取完整带域名的地址在手册路由生成有源方法只不过助手函数更方便资源路由创建资源资源路由采用固定的常用方法来实现简化的功能系统提供了一个命令方便开发者快速生成一个资源控制器以上的两部操作创建了一个控制器类并生成了增删改查操作的方法而且还实现了全部路由标识请求类型路由规则操作方法地址资源路由注册好后所有地址都是全自动生成具体如下访问的是方法用于显示数据访问的是方法新增数据的表单页面访问的是方法读取指定的一条数据访问的是方法读取指定数据并显示修改表单访问的是方法用于接收表单提交的新增数据访问的是方法用于接收表单提交的修改数据访问的是方法用于接收数据删除信息默认的参数采用名称如果你想别的比如相应的也可以通过方法限定系统提供的资源方法只允许指定的这些操作还可以通过方法排除系统提供的资源方法相反操作使用方法更改系统给予的默认方法请求方式地址操作批量支持嵌套资源路由类似于一对多关联的感觉实战中用到再操作详情查看手册视图变量渲染视图操作首先为了方便后续课程学习先把路由给关闭了并创建一个用于测试视图的控制器是否启用路由视图控制器由于我们不用模板引擎直接使用原生就需要使用方法载入模板载入原生模板模板地址为或修改配置文件将改为就可以使用助手函数如果希望模板后缀为方便混编在设置模板后缀在方法的第二参数通过数组方式给模板传递变量或表单提交先载入一个表单页面创建一个表单提交接受数据请求对象变量信息请求对象上一节课中表单提交时我们接受数据使用了方法这哪里来的因为我们的控制器继承了追踪进去可以看到成员字段关于这个知识点的源知识点可以参考手册架构容器和依赖注入讲过不讲了在没有继承时我们需要自己手动注入请求依赖注入上面的请求方式比较原始过于麻烦不推荐了第二种方式门面它相关的知识点在手册架构门面第三种方式继承其实就是第一种只不过被封装到基类中去了第四种方式终极方法助手函数请求信息在手册请求请求信息里有全部的请求方法模块这里列举几个意思一下方法含义当前访问域名或者当前访问的端口当前完整访问根地址当前请求类型我们三种方法演示一遍最终选一种你喜欢的即可当前请求方法更多的对照手册自行测试即可请求变量对象支持全局变量的检测获取和安全过滤支持等使用方法可以检测全局变量是否已经设置判断是否有模式下的值更多方法参看手册请求输入变量这里意思几个方法描述获取当前请求变量获取变量获取变量获取变量获取变量获取变量方法是框架推荐的方法可以自动识别诸如等数据信息可以获取模式的值此时只能是获取默认值实际上页面也转行成空判断也成立空字符串无名氏无名氏可在配置过滤器我你将特殊字符转换实体如果不想要全局过滤器可以直接局部设置了全局过滤器但某个不想用使用变量修饰符可以将参数强制转换成指定的类型字符串整型布尔数组浮点设置允许和排查可接受的变量允许和变量默认值设置默认值参数二可设置还是等以上所有都封装到助手函数里了判断下的是否存在判断下的是否存在获取下的值默认值默认值过滤器设置强制转换请求类型输出重定向请求类型对象提供了一个方法来获取当前请求类型也提供了判断当前的请求类型方法说明获取当前请求类型判断是否请求判断是否请求判断是否请求判断是否请求判断是否请求使用请求类型伪装可以提交类型载入表单模板表单提交判断是否请求直接伪装在后续添加即可结合前段时再研究响应输出响应输出有好几种包括和等等默认输出方式是以格式输出如果你发起请求则输出而背后是对象可以用输出达到相同的效果等同于方法可以设置第二参数状态码或调用方法参数二发送状态码或和均支持状态码重定向使用方法可以实现页面重定向需要执行首页访问路由页面外加状态码访问生成的地址还支持跳转和记住上一次地址的跳转实战时再研究中间件定义定义中间件中间件的主要用于拦截和过滤请求并进行相应处理这些请求的功能可以是重定向权限验证等等为了进一步了解中间件的用法我们首先定义一个基础的中间件可以通过命令行模式在应用目录下生成一个中间件文件和文件夹拦截请求继续往执行然后将这个中间件进行注册在应用目录下的文件中配置注册中间件中间件的入口执行方法必须是方法第一参数请求第二参数是闭包业务代码判断请求的如果等于就拦截住执行中间件跳转到首页但如果请求的是那需要继续往下执行才行不能被拦死那么就需要把这个请求去调用回调函数中间件方法规定需要返回对象才能正常使用而执行后就是返回的对象为了测试拦截后无法继续执行可以助手函数测试前后置中间件将放在方法底部的方式属于前置中间件前置中间件就是请求阶段来进行拦截验证比如登录判断跳转权限等而后置中间件就是请求完毕之后再进行验证比如写入日志等等中间件代码前置中间件代码后置先执行内容再执行中间件拦截请求中间件操作路由中间件创建一个给路由使用的中间件判断路由的值实现相应的验证路由方法提供了一个方法让指定的路由采用指定的中间件限定这个路由采用了中间件导入后可以省略路由采用多个中间件也可以在配置文件加中配置别名支持别名或分组当然路由分组也支持控制器中间件如果不用路由怎么用局部化的中间件呢当然也可以直接在控制器上定义这里是别名方式和路由一样另外两种均支持默认是控制器全体方法有效如果需要限制还是和',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-07-18 17:14:21',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/Sherlock.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">Sherlock</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/essay/"><span> 闲言碎语</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> Search</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> Newest Comments</span></div><div class="aside-list"><span>loading...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/cors/" style="font-size: 1.05rem;">cors<sup>1</sup></a><a href="/tags/csrf/" style="font-size: 1.05rem;">csrf<sup>1</sup></a><a href="/tags/php/" style="font-size: 1.05rem;">php<sup>5</sup></a><a href="/tags/python/" style="font-size: 1.05rem;">python<sup>3</sup></a><a href="/tags/sql/" style="font-size: 1.05rem;">sql<sup>3</sup></a><a href="/tags/ssrf/" style="font-size: 1.05rem;">ssrf<sup>1</sup></a><a href="/tags/ssti/" style="font-size: 1.05rem;">ssti<sup>2</sup></a><a href="/tags/web/" style="font-size: 1.05rem;">web<sup>3</sup></a><a href="/tags/xss/" style="font-size: 1.05rem;">xss<sup>1</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 1.05rem;">前端<sup>2</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>Archives</span><a class="card-more-btn" href="/archives/" title="More">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">August 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">July 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">June 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">May 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">April 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">March 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">February 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">January 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url">开发</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/php/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>php</span></a></span></div></div><h1 class="post-title" itemprop="name headline">thinkphp学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-07-14T08:03:16.000Z" title="Created 2024-07-14 16:03:16">2024-07-14</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-07-18T09:14:21.102Z" title="Updated 2024-07-18 17:14:21">2024-07-18</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为福建"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>福建</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2024/07/14/thinkphp%E5%AD%A6%E4%B9%A0/"><header><a class="post-meta-categories" href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url">开发</a><a href="/tags/php/" tabindex="-1" itemprop="url">php</a><h1 id="CrawlerTitle" itemprop="name headline">thinkphp学习</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Sherlock</span><time itemprop="dateCreated datePublished" datetime="2024-07-14T08:03:16.000Z" title="Created 2024-07-14 16:03:16">2024-07-14</time><time itemprop="dateCreated datePublished" datetime="2024-07-18T09:14:21.102Z" title="Updated 2024-07-18 17:14:21">2024-07-18</time></header><h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_62797596/article/details/134713455">thinkPHP8.0安装与避坑</a></p>
<p><a target="_blank" rel="noopener" href="https://doc.thinkphp.cn/v8_0">ThinPHP官方手册</a></p>
<h1 id="安装thinphp8-0"><a href="#安装thinphp8-0" class="headerlink" title="安装thinphp8.0"></a>安装thinphp8.0</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--1、访问网址下载安装composer--&gt;</span><br><span class="line">https://getcomposer.org/Composer-Setup.exe</span><br><span class="line">&lt;!--2、配置镜像源防止乱七八糟的网络和GitHub仓库拉取无权限问题--&gt;</span><br><span class="line">composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/</span><br><span class="line">&lt;!--3、在网站根目录(www)下进入cmd创建项目--&gt;</span><br><span class="line">composer create-project topthink/think tp</span><br><span class="line">cd tp</span><br><span class="line">&lt;!--4、解决依赖项报错--&gt;</span><br><span class="line">composer up --ignore-platform-reqs</span><br><span class="line">&lt;!--5、运行命令查看效果--&gt;</span><br><span class="line">php think run</span><br><span class="line">&lt;!--6、访问查看结果，这里有坑：不能直接访问0.0.0.0:8000这个地址--&gt;</span><br><span class="line">127.0.0.1:8000</span><br></pre></td></tr></table></figure>

<p>在第三步创建tk项目时候有报错是正常的，因为有依赖项无法安装的问题(我安装时候的PHP解释器版本是8.2.9)，所以需要切换到tk项目目录下执行命令解决依赖项无法安装的问题</p>
<h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><h3 id="单应用模式"><a href="#单应用模式" class="headerlink" title="单应用模式"></a>单应用模式</h3><p>默认安装后的目录结构就是单应用目录结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">www  WEB部署目录（或者子目录）</span><br><span class="line">├─app           应用目录</span><br><span class="line">│  ├─controller      控制器目录</span><br><span class="line">│  ├─model           模型目录</span><br><span class="line">│  ├─ ...            更多类库目录</span><br><span class="line">│  │</span><br><span class="line">│  ├─common.php         公共函数文件</span><br><span class="line">│  └─event.php          事件定义文件</span><br><span class="line">│</span><br><span class="line">├─config                配置目录</span><br><span class="line">│  ├─app.php            应用配置</span><br><span class="line">│  ├─cache.php          缓存配置</span><br><span class="line">│  ├─console.php        控制台配置</span><br><span class="line">│  ├─cookie.php         Cookie配置</span><br><span class="line">│  ├─database.php       数据库配置</span><br><span class="line">│  ├─filesystem.php     文件磁盘配置</span><br><span class="line">│  ├─lang.php           多语言配置</span><br><span class="line">│  ├─log.php            日志配置</span><br><span class="line">│  ├─middleware.php     中间件配置</span><br><span class="line">│  ├─route.php          URL和路由配置</span><br><span class="line">│  ├─session.php        Session配置</span><br><span class="line">│  ├─trace.php          Trace配置</span><br><span class="line">│  └─view.php           视图配置</span><br><span class="line">│</span><br><span class="line">├─view            视图目录</span><br><span class="line">├─route                 路由定义目录</span><br><span class="line">│  ├─route.php          路由定义文件</span><br><span class="line">│  └─ ...   </span><br><span class="line">│</span><br><span class="line">├─public                WEB目录（对外访问目录）</span><br><span class="line">│  ├─index.php          入口文件</span><br><span class="line">│  ├─router.php         快速测试文件</span><br><span class="line">│  └─.htaccess          用于apache的重写</span><br><span class="line">│</span><br><span class="line">├─extend                扩展类库目录</span><br><span class="line">├─runtime               应用的运行时目录（可写，可定制）</span><br><span class="line">├─vendor                Composer类库目录</span><br><span class="line">├─.example.env          环境变量示例文件</span><br><span class="line">├─composer.json         composer 定义文件</span><br><span class="line">├─LICENSE.txt           授权说明文件</span><br><span class="line">├─README.md             README 文件</span><br><span class="line">├─think                 命令行入口文件</span><br></pre></td></tr></table></figure>

<h3 id="多应用模式"><a href="#多应用模式" class="headerlink" title="多应用模式"></a>多应用模式</h3><p>详见官方手册</p>
<h3 id="默认应用文件"><a href="#默认应用文件" class="headerlink" title="默认应用文件"></a>默认应用文件</h3><p>默认安装后，<code>app</code>目录下会包含下面的文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">├─app           应用目录</span><br><span class="line">│  │</span><br><span class="line">│  ├─BaseController.php    默认基础控制器类</span><br><span class="line">│  ├─ExceptionHandle.php   应用异常定义文件</span><br><span class="line">│  ├─common.php            全局公共函数文件</span><br><span class="line">│  ├─middleware.php        全局中间件定义文件</span><br><span class="line">│  ├─provider.php          服务提供定义文件</span><br><span class="line">│  ├─Request.php           应用请求对象</span><br><span class="line">│  └─event.php             全局事件定义文件</span><br></pre></td></tr></table></figure>

<p><code>BaseController.php</code>、<code>Request.php</code> 和<code>ExceptionHandle.php</code>三个文件是系统默认提供的基础文件，位置你可以随意移动，但注意要同步调整类的命名空间。如果你不需要使用<code>Request.php</code> 和<code>ExceptionHandle.php</code>文件，或者要调整类名，记得必须同步调整<code>provider.php</code>文件中的容器对象绑定。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ul>
<li>默认情况下，程序出错会显示：页面出错！请稍候再试~</li>
<li>这种情况，一般是应用部署好后，万一出错给用户看的；</li>
<li>如果我们自己在开发阶段，需要开启调试模式，来提示具体的错误信息：<ul>
<li>在根目录有一个文件：.example.env，改成 .env ，也就是去掉点前面；（环境变量文件）</li>
<li>然后在配置信息的第一行：APP_DEBUG &#x3D; true 即可，false则不开启。</li>
</ul>
</li>
</ul>
<p>开启后会如下所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../source/imgs/$%7Bfiilname%7D/image-20240714171457372.png" alt="image-20240714171457372"></p>
<ul>
<li>调试模式开启后，可以发现右下角会出现trace调试工具小图标：<ul>
<li>包含了丰富的调试内容：具体自点查看。</li>
</ul>
</li>
</ul>
<h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><h2 id="HTTP请求流程"><a href="#HTTP请求流程" class="headerlink" title="HTTP请求流程"></a>HTTP请求流程</h2><p>对于一个HTTP应用来说，从用户发起请求到响应输出结束，大致的标准请求流程如下：</p>
<ul>
<li>载入<code>Composer</code>的自动加载<code>autoload</code>文件</li>
<li>实例化系统应用基础类<code>think\App</code></li>
<li>获取应用目录等相关路径信息</li>
<li>加载全局的服务提供<code>provider.php</code>文件</li>
<li>设置容器实例及应用对象实例，确保当前容器对象唯一</li>
<li>从容器中获取<code>HTTP</code>应用类<code>think\Http</code></li>
<li>执行<code>HTTP</code>应用类的<code>run</code>方法启动一个<code>HTTP</code>应用</li>
<li>获取当前请求对象实例（默认为 <code>app\Request</code> 继承<code>think\Request</code>）保存到容器</li>
<li>执行<code>think\App</code>类的初始化方法<code>initialize</code></li>
<li>加载环境变量文件<code>.env</code>和全局初始化文件</li>
<li>加载全局公共文件、系统助手函数、全局配置文件、全局事件定义和全局服务定义</li>
<li>判断应用模式（调试或者部署模式）</li>
<li>监听<code>AppInit</code>事件</li>
<li>注册异常处理</li>
<li>服务注册</li>
<li>启动注册的服务</li>
<li>加载全局中间件定义</li>
<li>监听<code>HttpRun</code>事件</li>
<li>执行全局中间件</li>
<li>执行路由调度（<code>Route</code>类<code>dispatch</code>方法）</li>
<li>如果开启路由则检查路由缓存</li>
<li>加载路由定义</li>
<li>监听<code>RouteLoaded</code>事件</li>
<li>如果开启注解路由则检测注解路由</li>
<li>路由检测（中间流程很复杂 略）</li>
<li>路由调度对象<code>think\route\Dispatch</code>初始化</li>
<li>设置当前请求的控制器和操作名</li>
<li>注册路由中间件</li>
<li>绑定数据模型</li>
<li>设置路由额外参数</li>
<li>执行数据自动验证</li>
<li>执行路由调度子类的<code>exec</code>方法返回响应<code>think\Response</code>对象</li>
<li>获取当前请求的控制器对象实例</li>
<li>利用反射机制注册控制器中间件</li>
<li>执行控制器方法以及前后置中间件</li>
<li>执行当前响应对象的<code>send</code>方法输出</li>
<li>执行HTTP应用对象的<code>end</code>方法善后</li>
<li>监听<code>HttpEnd</code>事件</li>
<li>执行中间件的<code>end</code>回调</li>
<li>写入当前请求的日志信息</li>
</ul>
<h2 id="入口文件"><a href="#入口文件" class="headerlink" title="入口文件"></a>入口文件</h2><p>ThinkPHP<code>8.0</code>采用<strong>单一入口模式</strong>进行项目部署和访问，一个应用都有一个统一（但不一定是唯一）的入口。如果采用自动多应用部署的话，一个入口文件还可以自动对应多个应用。</p>
<h3 id="应用入口文件"><a href="#应用入口文件" class="headerlink" title="应用入口文件"></a>应用入口文件</h3><p>默认的应用入口文件位于<code>public/index.php</code>，如果你没有特殊的自定义需求，无需对入口文件做任何的更改。入口文件位置的设计是为了让应用部署更安全，请尽量遵循<code>public</code>目录为唯一的<code>web</code>可访问目录，其他的文件都可以放到非WEB访问目录下面</p>
<h3 id="控制台入口文件"><a href="#控制台入口文件" class="headerlink" title="控制台入口文件"></a>控制台入口文件</h3><p>除了应用入口文件外，系统还提供了一个控制台入口文件（即位于项目根目录的<code>think</code>文件）</p>
<p>控制台入口文件用于执行控制台指令，例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think version</span><br></pre></td></tr></table></figure>

<p>系统内置了一些常用的控制台指令，如果你安装了额外的扩展，也会增加相应的控制台指令，都是通过该入口文件执行的。</p>
<h2 id="多应用模式-1"><a href="#多应用模式-1" class="headerlink" title="多应用模式"></a>多应用模式</h2><p>详见官方手册</p>
<h2 id="URL访问"><a href="#URL访问" class="headerlink" title="URL访问"></a>URL访问</h2><h3 id="单应用URL"><a href="#单应用URL" class="headerlink" title="单应用URL"></a>单应用URL</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//serverName/index.php/控制器/操作/参数/值…</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>注意：这里服务器启动是 php think run 的内置服务器，下节课会探讨外置服务器；</p>
</li>
<li><p>结构分析：</p>
<ul>
<li><p>serverName就是我们的：<code>127.0.0.1:8000</code>；</p>
</li>
<li><p>index.php 是入口文件，带上 <code>/</code> ；</p>
</li>
<li><p>控制器是app\controller\Index.php中的 Index 这个名称，也就是类名；</p>
</li>
<li><p>操作是类里面的方法名，比如：index（默认方法），hello（普通方法）；</p>
</li>
<li><p>默认方法可以省略，会直接方法，其他普通方法需要键入方法名：</p>
<ul>
<li><code>http://127.0.0.1:8000/index.php/Index</code> (默认执行index操作)</li>
<li><code>http://127.0.0.1:8000/index.php/Index/index</code> (完整路径)</li>
<li><code>http://127.0.0.1:8000/index.php/Index/test</code> (普通方法，必须完整路径)</li>
</ul>
</li>
<li><p>系统默认自带的hello方法，是针对后续路由的，在路由文件设置过导致无效；</p>
</li>
<li><p>我们在config&#x2F;app.php中将路由关闭：<code>&quot;with_route&quot;  =&gt; false</code>,</p>
<ul>
<li><code>http://127.0.0.1:8000/index.php/Index/hello</code> （执行默认参数值）</li>
<li><code>http://127.0.0.1:8000/index.php/Index/hello/name/World</code>（修改参数值）</li>
</ul>
</li>
<li><p>参数不够直观，尤其多参数的时候，也是支持传统方案的：</p>
<ul>
<li><code>http://127.0.0.1:8000/index.php/Index/hello?name=World</code> （问号键值对）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="URL重写"><a href="#URL重写" class="headerlink" title="URL重写"></a>URL重写</h3><p>可以通过URL重写隐藏应用的入口文件<code>index.php</code>（也可以是其它的入口文件，但URL重写通常只能设置一个入口文件）,下面是相关服务器的配置参考：</p>
<h4 id="Apache"><a href="#Apache" class="headerlink" title="[ Apache ]"></a>[ Apache ]</h4><ol>
<li><code>httpd.conf</code>配置文件中加载了<code>mod_rewrite.so</code>模块</li>
<li><code>AllowOverride None</code> 将<code>None</code>改为 <code>All</code></li>
<li>把下面的内容保存为<code>.htaccess</code>文件放到应用入口文件的同级目录下</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;IfModule mod_rewrite.c&gt;</span><br><span class="line">  Options +FollowSymlinks -Multiviews</span><br><span class="line">  RewriteEngine On</span><br><span class="line"></span><br><span class="line">  RewriteCond %&#123;REQUEST_FILENAME&#125; !-d</span><br><span class="line">  RewriteCond %&#123;REQUEST_FILENAME&#125; !-f</span><br><span class="line">  RewriteRule ^(.*)$ index.php/$1 [QSA,PT,L]</span><br><span class="line">&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure>

<h4 id="Nginx"><a href="#Nginx" class="headerlink" title="[ Nginx ]"></a>[ Nginx ]</h4><p>在Nginx低版本中，是不支持PATHINFO的，但是可以通过在<code>Nginx.conf</code>中配置转发规则实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location / &#123; // …..省略部分代码</span><br><span class="line">   if (!-f $request_filename) &#123;</span><br><span class="line">   		rewrite  ^(.*)$  /index.php?s=/$1  last;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实内部是转发到了ThinkPHP提供的兼容URL，利用这种方式，可以解决其他不支持PATHINFO的WEB服务器环境。</p>
<p>外置服务器，比如phpEnv，省略了入口文件，则出现如下问题：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../source/imgs/$%7Bfiilname%7D/image-20240715152316496.png" alt="image-20240715152316496"></p>
<p>查看手册，根据它URL重写的修改方案（Apache），需要修改.htaccess最后一行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#RewriteRule ^(.*)$ index.php/$1 [QSA,PT,L]  Apache替换成下面一行</span></span><br><span class="line">RewriteRule ^(.*)$ index.php [L,E=PATH_INFO:$<span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<h1 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><ul>
<li><p>控制器：顾名思义MVC中的C，即逻辑控制定义；</p>
</li>
<li><p>默认在app\controller下编写对应的控制器类文件，如果想改默认目录，在&#x2F;config&#x2F;route.php中进行修改：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 访问控制器层名称</span></span><br><span class="line"><span class="string">&quot;controller_layer&quot;</span>      =&gt; <span class="string">&quot;controller&quot;</span>,</span><br></pre></td></tr></table></figure>
</li>
<li><p>类名和文件名大小写保持一致，并采用驼峰式（首字母大写）；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;用户！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;city&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;登陆成功！&quot;</span>.<span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ul>
<li>User类创建两个方法 index(默认)和 login，访问 URL 如下：</li>
<li><code>http://127.0.0.1:8000/index.php/user/</code></li>
<li><code>http://127.0.0.1:8000/index.php/user/login</code></li>
<li><code>http://127.0.0.1:8000/index.php/User/login?name = Mancity</code></li>
</ul>
</li>
<li><p>那么如果创建的是双字母组合，比如 class HelloWorld，访问 URL 如下：</p>
</li>
<li><p><code>http://127.0.0.1:8000/Index.php/helloworld</code></p>
</li>
<li><p><code>http://127.0.0.1:8000/Index.php/Hello_World</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello world!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="基础和空控制器"><a href="#基础和空控制器" class="headerlink" title="基础和空控制器"></a>基础和空控制器</h2><h3 id="基础控制器"><a href="#基础控制器" class="headerlink" title="基础控制器"></a>基础控制器</h3><ul>
<li><p>一般来说，创建控制器后，推荐继承基础控制器来获得更多的功能方法；</p>
</li>
<li><p>基础控制器仅仅提供了控制器验证功能，并注入了think\App和think\Request；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">BaseController</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 返回实际路径</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">getBasePath</span>();</span><br><span class="line">        <span class="comment">// 返回当前方法名</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">action</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="空控制器"><a href="#空控制器" class="headerlink" title="空控制器"></a>空控制器</h3><ul>
<li><p>空控制器一般用于载入不存在的控制器时，进行错误提示；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Error</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span>, <span class="keyword">array</span> <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;当前控制器不存在！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><h2 id="创建数据库及表"><a href="#创建数据库及表" class="headerlink" title="创建数据库及表"></a>创建数据库及表</h2><p>我这边使用navicat软件配合phpstudy进行创建的，这边我就不详细说明了</p>
<h2 id="连接数据库和查询"><a href="#连接数据库和查询" class="headerlink" title="连接数据库和查询"></a>连接数据库和查询</h2><h3 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h3><ul>
<li><p>我们可以在 <strong>config\database.php</strong> 配置文件中设置与数据库的连接信息：</p>
<ul>
<li><p>如果是一般性数据库连接，在 <strong>‘’connections‘’</strong> 配置区设置即可；</p>
</li>
<li><p>如果是本地测试，它会优先读取 <strong>.env</strong> 配置，然后再读取 <strong>database.php</strong> 的配置；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># .env文件，部署服务器，请禁用我</span><br><span class="line">APP_DEBUG = true</span><br><span class="line"></span><br><span class="line">DB_TYPE = mysql</span><br><span class="line">DB_HOST = 127.0.0.1</span><br><span class="line">DB_NAME = demo</span><br><span class="line">DB_USER = root</span><br><span class="line">DB_PASS = 123456</span><br><span class="line">DB_PORT = 3306</span><br><span class="line">DB_CHARSET = utf8</span><br><span class="line"></span><br><span class="line">DEFAULT_LANG = zh-cn</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果禁用了 .env 配置，则会读取数据库连接的默认配置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据库连接配置信息</span></span><br><span class="line"><span class="string">&quot;connections&quot;</span>     =&gt; [</span><br><span class="line">    <span class="string">&quot;mysql&quot;</span> =&gt; [</span><br><span class="line">        <span class="comment">// 数据库类型</span></span><br><span class="line">        <span class="string">&quot;type&quot;</span>            =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&quot;DB_TYPE&quot;</span>, <span class="string">&quot;mysql&quot;</span>),</span><br><span class="line">        <span class="comment">// 服务器地址</span></span><br><span class="line">        <span class="string">&quot;hostname&quot;</span>        =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&quot;DB_HOST&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>),</span><br><span class="line">        <span class="comment">// 数据库名</span></span><br><span class="line">        <span class="string">&quot;database&quot;</span>        =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&quot;DB_NAME&quot;</span>, <span class="string">&quot;demo&quot;</span>),</span><br><span class="line">        <span class="comment">// 用户名</span></span><br><span class="line">        <span class="string">&quot;username&quot;</span>        =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&quot;DB_USER&quot;</span>, <span class="string">&quot;root&quot;</span>),</span><br><span class="line">        <span class="comment">// 密码</span></span><br><span class="line">        <span class="string">&quot;password&quot;</span>        =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&quot;DB_PASS&quot;</span>, <span class="string">&quot;123456&quot;</span>),</span><br><span class="line">        <span class="comment">// 端口</span></span><br><span class="line">        <span class="string">&quot;hostport&quot;</span>        =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&quot;DB_PORT&quot;</span>, <span class="string">&quot;3306&quot;</span>),</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="PHP获取数据"><a href="#PHP获取数据" class="headerlink" title="PHP获取数据"></a>PHP获取数据</h3><ul>
<li><p>我们暂时没有详细学习此类语法，可以简单用一些了解一下即可：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入Db数据库类</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">facade</span>\<span class="title">Db</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 连接user表，查询</span></span><br><span class="line">        <span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">table</span>(<span class="string">&quot;users&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line">        <span class="comment">// 输出数据</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$user</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="数据查询"><a href="#数据查询" class="headerlink" title="数据查询"></a>数据查询</h2><h3 id="table方法"><a href="#table方法" class="headerlink" title="table方法"></a>table方法</h3><ul>
<li><p>Db类旗下有一个 <strong>table</strong> 静态调用的方法，参数为完整的表名（前缀都不能省略）；</p>
</li>
<li><p>如果希望只查询一条数据，可以使用 <strong>find()</strong> 方法，需指定 <strong>where</strong> 条件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过ID查询指定的数据</span></span><br><span class="line"><span class="comment">// find 方法查询结果不存在，返回 null，否则返回结果数组</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">table</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="number">1</span>)-&gt;<span class="title function_ invoke__">find</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>想要了解执行的原生SQL是什么，可以注释掉 return 直接通过 trace 查看；</p>
</li>
<li><p>使用 <strong>findOrEmpty()</strong> 方法也可以查询一条数据，但在没有数据时返回一个空数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 没有数据返回空数组</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">table</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="number">11</span>)-&gt;<span class="title function_ invoke__">findOrEmpty</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>findOrFail()</strong> 方法同样可以查询一条数据，在没有数据时抛出一个异常：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 没有数据抛出异常</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">table</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="number">11</span>)-&gt;<span class="title function_ invoke__">findOrFail</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>想要获取多列数据，可以使用 <strong>select()</strong> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询所有数据</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">table</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>select()</strong> 方法默认返回 <strong>Collection</strong> 对象的数据集，可以通过 <strong>toArray()</strong> 方法转换成数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用中断函数，来检测返回值</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">table</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="title function_ invoke__">halt</span>(<span class="variable">$user</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换成数组</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">table</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>()-&gt;<span class="title function_ invoke__">toArray</span>();</span><br><span class="line"><span class="title function_ invoke__">halt</span>(<span class="variable">$user</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>多列数据也可以参与 where() 方法的筛选：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多列筛选</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">table</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;age&quot;</span>, <span class="number">14</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="链式查询"><a href="#链式查询" class="headerlink" title="链式查询"></a>链式查询</h3><ul>
<li>我们发现通过指向符号 “-&gt;” 多次连续调用方法称为：链式查询；</li>
<li>当 Db::table(“user”) 时，返回查询对象（Query），即可连缀数据库对应的方法；</li>
<li>当返回查询对象（Query）时，就可以继续调用链式方法，where() 也是链式方法；</li>
<li>而 where() 被调用后，依旧返回（Query），可以再次链式调用；</li>
<li>在手册 <strong>数据库 -&gt; 查询构造器 -&gt; 链式操作</strong> 可以了解所有可链式的方法：table、where等；</li>
<li>直到遇到 find() 或 select() 返回数组或数据集时，结束查询；</li>
</ul>
<h3 id="表达式查询"><a href="#表达式查询" class="headerlink" title="表达式查询"></a><strong>表达式查询</strong></h3><ul>
<li><p>查询表达式支持大部分常用的 SQL 语句，语法格式如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">where</span>(<span class="string">&quot;字段名&quot;</span>,<span class="string">&quot;查询表达式&quot;</span>,<span class="string">&quot;查询条件&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>所有的表达式，查阅手册 -&gt; 查询表达式 中的表格即可；这里列出几个意思一下：</p>
<table>
<thead>
<tr>
<th align="center">表达式</th>
<th align="center">含义</th>
<th align="center">快捷方式</th>
</tr>
</thead>
<tbody><tr>
<td align="center">&#x3D;</td>
<td align="center">等于</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">&lt;&#x3D; time</td>
<td align="center">小于等于某个时间</td>
<td align="center">whereTime</td>
</tr>
<tr>
<td align="center">EXP</td>
<td align="center">SQL表达式查询</td>
<td align="center">whereExp</td>
</tr>
<tr>
<td align="center">[NOT] LIKE</td>
<td align="center">模糊查询</td>
<td align="center">whereLike</td>
</tr>
<tr>
<td align="center">[NOT] IN</td>
<td align="center">[非] IN 查询</td>
<td align="center">whereIN</td>
</tr>
</tbody></table>
</li>
</ul>
<h4 id="查询示例"><a href="#查询示例" class="headerlink" title="查询示例"></a><strong>查询示例</strong></h4><ul>
<li><p>条件判断类的，id大于4的；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询id大于4的数据</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="number">4</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$user</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Like模糊查询，姓王的；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询姓王的用户</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;like&quot;</span>, <span class="string">&quot;王%&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="comment">// like快捷方式</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereLike</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;王%&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>IN区间查询，根据id；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 区间查询，支持not in</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;in&quot;</span>, <span class="string">&quot;1, 3, 5&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="comment">// 语义更好一点</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;in&quot;</span>, [<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>])-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="comment">// IN快捷查询，两种均可，支持whereNotIn</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereIn</span>(<span class="string">&quot;id&quot;</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="comment">// Between，和IN一样 支持 not between</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;between&quot;</span>, [<span class="number">2</span>,<span class="number">5</span>])-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="comment">// 快捷方式和IN一样：whereBetween和whereNotBetween</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>NULL查询；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NULL,  null 或 not null：</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;details&quot;</span>, <span class="string">&quot;not null&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="comment">// 快捷方式：whereNull和whereNotNull</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>EXP查询，自定义SQL片段；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EXP查询，自定义SQL</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;EXP&quot;</span>, <span class="string">&quot;&lt;&gt; 8 and id &gt;5&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="comment">// 快捷查询</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereExp</span>(<span class="string">&quot;id&quot;</span>,<span class="string">&quot;&lt;&gt; 8 and id &gt;5&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="表前缀之扩展查询"><a href="#表前缀之扩展查询" class="headerlink" title="表前缀之扩展查询"></a>表前缀之扩展查询</h2><h3 id="表前缀"><a href="#表前缀" class="headerlink" title="表前缀"></a>表前缀</h3><ul>
<li><p>一般来说，为了保持表名统一性和防止冲突，都会给表加上一个前缀，以下划线结束；</p>
<ul>
<li><p>比如：<strong>tp_user</strong>，这里的 <strong>tp_</strong> 就是表前缀，所有；</p>
</li>
<li><p>我们修改MySQL中表名，然后刷新程序，报错；</p>
</li>
<li><p>当然，你可以传递 **Db::table(“tp_user”)**，但没必要；</p>
</li>
</ul>
</li>
<li><p>首先，我们可以来配置统一前缀：</p>
<ul>
<li><p>在 .env 文件中 添加：<code>DB_PREFIX = tp_</code></p>
</li>
<li><p>如果部署环境 database.php 中 设置</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;prefix&quot;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&quot;DB_PREFIX&quot;</span>, <span class="string">&quot;tp_&quot;</span>),</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>然后，使用 <strong>Db::name(“user”)</strong> 方法即可：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此时，tp_ 表名的前缀可以省略</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="扩展查询"><a href="#扩展查询" class="headerlink" title="扩展查询"></a>扩展查询</h3><ul>
<li><p>通过 <strong>value()</strong> 方法，可以查询指定字段的值（单个），没有数据返回 <strong>null</strong> ；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// value() 方法查询单个列值</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="number">3</span>)-&gt;<span class="title function_ invoke__">value</span>(<span class="string">&quot;name&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过 <strong>colunm()</strong> 方法，可以查询指定列的值（多个），没有数据返回空数组；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// colunm() 方法查询多个列值</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">column</span>(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="comment">// 通过id 作为索引</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">column</span>(<span class="string">&quot;name,age&quot;</span>, <span class="string">&quot;id&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>当大量数据需要 <strong>批处理</strong> 时，比如给所有用户更新数据，就不能一次性全取出来，一批一批的来；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 批量处理</span></span><br><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">chunk</span>(<span class="number">2</span>, function (<span class="variable">$users</span>) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$users</span> <span class="keyword">as</span> <span class="variable">$user</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">dump</span>(<span class="variable">$user</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="number">1</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过获取最后的SQL语句，发现用的是LIMIT 2</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Db</span>::<span class="title function_ invoke__">getLastSql</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>另一种处理大量数据：<strong>游标查询</strong>，为了解决内存开销，每次读取一行，并返回到下一行再读取；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 批量处理2</span></span><br><span class="line"><span class="variable">$users</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">cursor</span>();</span><br><span class="line"><span class="comment">// PHP生成器</span></span><br><span class="line"><span class="comment">// halt($user);</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$users</span> <span class="keyword">as</span> <span class="variable">$user</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">dump</span>(<span class="variable">$user</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="添加数据"><a href="#添加数据" class="headerlink" title="添加数据"></a>添加数据</h2><h3 id="单条新增"><a href="#单条新增" class="headerlink" title="单条新增"></a>单条新增</h3><ul>
<li><p>使用 <strong>insert()</strong> 方法可以向数据表添加一条数据，更多的字段采用默认；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 数据</span></span><br><span class="line"><span class="variable">$data</span> = [</span><br><span class="line">    <span class="string">&quot;name&quot;</span>    =&gt; <span class="string">&quot;张麻子&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>     =&gt; <span class="number">28</span>,</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>  =&gt; <span class="string">&quot;男&quot;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单条新增，成功返回1</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">insert</span>(<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果想强行新增抛弃不存在的字段数据，则使用 <strong>strick(false)</strong> 方法，忽略异常；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据</span></span><br><span class="line"><span class="variable">$data</span> = [</span><br><span class="line">    <span class="string">&quot;name&quot;</span>    =&gt; <span class="string">&quot;马邦德&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>     =&gt; <span class="number">30</span>,</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>  =&gt; <span class="string">&quot;男&quot;</span>,</span><br><span class="line">    <span class="string">&quot;deta&quot;</span> =&gt; <span class="string">&quot;我脸上没有麻子！&quot;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单条新增，成功返回1</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">strict</span>(<span class="literal">false</span>)-&gt;<span class="title function_ invoke__">insert</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果我们采用的数据库是 mysql，可以支持 <strong>replace</strong> 写入；</p>
</li>
<li><p>insert 和 replace insert 写入的区别，前者表示表中存在主键相同则报错，后者则修改；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新增数据时，主键冲突时，直接修改这条记录</span></span><br><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">replace</span>()-&gt;<span class="title function_ invoke__">insert</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>insertGetId()</strong> 方法，可以在新增成功后返回当前数据 ID；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回自增ID</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">replace</span>()-&gt;<span class="title function_ invoke__">insertGetId</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="多条新增"><a href="#多条新增" class="headerlink" title="多条新增"></a>多条新增</h3><ul>
<li><p>使用 <strong>insertAll()</strong> 方法，可以批量新增数据，但要保持数组结构一致；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据</span></span><br><span class="line"><span class="variable">$data</span> = [[</span><br><span class="line">    <span class="string">&quot;name&quot;</span>    =&gt; <span class="string">&quot;林克&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>     =&gt; <span class="number">19</span>,</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>  =&gt; <span class="string">&quot;男&quot;</span>,</span><br><span class="line">    <span class="string">&quot;details&quot;</span> =&gt; <span class="string">&quot;先收集999个呀哈哈！&quot;</span></span><br><span class="line">],[</span><br><span class="line">    <span class="string">&quot;name&quot;</span>    =&gt; <span class="string">&quot;普尔亚&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>     =&gt; <span class="number">100</span>,</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>  =&gt; <span class="string">&quot;女&quot;</span>,</span><br><span class="line">    <span class="string">&quot;details&quot;</span> =&gt; <span class="string">&quot;我先来个返老还童，再快速长大！&quot;</span></span><br><span class="line">]];</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">insertAll</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>insertAll()</strong> 方法 也支持 replace 写入，如果添加数据量大，可以通过 <strong>-&gt; limit()</strong> 方法限制添加数量；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">replace</span>()-&gt;<span class="title function_ invoke__">limit</span>(<span class="number">100</span>)-&gt;<span class="title function_ invoke__">insertAll</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="更新，删除以及save方法"><a href="#更新，删除以及save方法" class="headerlink" title="更新，删除以及save方法"></a>更新，删除以及save方法</h2><h3 id="数据修改"><a href="#数据修改" class="headerlink" title="数据修改"></a>数据修改</h3><ul>
<li><p>使用 <strong>update()</strong> 方法来修改数据，修改成功返回影响行数，没有修改返回 <strong>0</strong>；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改的数据</span></span><br><span class="line"><span class="variable">$data</span> = [</span><br><span class="line">    <span class="string">&quot;name&quot;</span> =&gt; <span class="string">&quot;王三狗&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>  =&gt; <span class="string">&quot;13&quot;</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行修改并返回</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="number">4</span>)-&gt;<span class="title function_ invoke__">update</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果修改数据包含了主键信息，比如 id，那么可以省略掉 where 条件；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改的数据</span></span><br><span class="line"><span class="variable">$data</span> = [</span><br><span class="line">    <span class="string">&quot;id&quot;</span>   =&gt; <span class="number">4</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span> =&gt; <span class="string">&quot;王三狗&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>  =&gt; <span class="string">&quot;13&quot;</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行修改并返回</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">update</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果想让一些字段修改时执行 SQL 函数操作，可以使用 <strong>exp()</strong> 方法实现；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 让details字段内的英文大写</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">exp</span>(<span class="string">&quot;details&quot;</span>, <span class="string">&quot;UPPER(details)&quot;</span>)-&gt;<span class="title function_ invoke__">update</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果要自增&#x2F;自减某个字段，可以使用 inc&#x2F;dec 方法，并支持自定义步长；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改时，让age自增和自减，默认1，要去掉$data里面age字段的修改，不然冲突</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">inc</span>(<span class="string">&quot;age&quot;</span>)-&gt;<span class="title function_ invoke__">dec</span>(<span class="string">&quot;age&quot;</span>, <span class="number">2</span>)-&gt;<span class="title function_ invoke__">update</span>(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 派生自字段，延迟执行，毫秒</span></span><br><span class="line"><span class="title function_ invoke__">setInc</span>(<span class="string">&quot;age&quot;</span>, <span class="number">1</span>, <span class="number">600</span>)</span><br><span class="line"><span class="title function_ invoke__">setDec</span>(<span class="string">&quot;age&quot;</span>, <span class="number">2</span>, <span class="number">600</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>Db::raw()</strong> 来设置每个字段的特殊需求，灵活且清晰：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用Db::raw 更加清晰灵活</span></span><br><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="number">4</span>)-&gt;<span class="title function_ invoke__">update</span>([</span><br><span class="line">    <span class="string">&quot;details&quot;</span>   =&gt;  <span class="title class_">Db</span>::<span class="title function_ invoke__">raw</span>(<span class="string">&quot;UPPER(details)&quot;</span>),</span><br><span class="line">    <span class="string">&quot;age&quot;</span>       =&gt;  <span class="title class_">Db</span>::<span class="title function_ invoke__">raw</span>(<span class="string">&quot;age-2&quot;</span>)</span><br><span class="line">]);</span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Db</span>::<span class="title function_ invoke__">getLastSql</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>save()</strong> 方法是一个通用方法，可以自行判断是新增还是修改(更新)数据；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 包含主键，即修改；否则，新增</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">save</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="数据删除"><a href="#数据删除" class="headerlink" title="数据删除"></a>数据删除</h3><ul>
<li><p>极简删除可以根据主键直接删除，删除成功返回影响行数，否则 0；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据主键删除</span></span><br><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">delete</span>(<span class="number">8</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据主键，还可以删除多条记录；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据主键删除多条</span></span><br><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">delete</span>([<span class="number">48</span>,<span class="number">49</span>,<span class="number">50</span>]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>正常情况下，通过 where()方法来删除；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 条件删除</span></span><br><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="number">47</span>)-&gt;<span class="title function_ invoke__">delete</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="其他各种查询方式"><a href="#其他各种查询方式" class="headerlink" title="其他各种查询方式"></a>其他各种查询方式</h2><h3 id="字符串条件"><a href="#字符串条件" class="headerlink" title="字符串条件"></a>字符串条件</h3><ul>
<li><p><strong>whereRaw</strong> 可以直接写入多条件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多条件字符串</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereRaw</span>(<span class="string">&quot;age &gt; 15 AND gender=&quot;</span>女<span class="string">&quot;&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>包含变量的多条件查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 变量</span></span><br><span class="line"><span class="variable">$age</span> = <span class="number">15</span>;</span><br><span class="line"><span class="variable">$gender</span> = <span class="string">&quot;女&quot;</span>;</span><br><span class="line"><span class="comment">// 预处理机制</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereRaw</span>(<span class="string">&quot;age&gt;:age AND gender=:gender&quot;</span>, [</span><br><span class="line">    <span class="string">&quot;age&quot;</span>       =&gt; <span class="variable">$age</span>,</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>    =&gt; <span class="variable">$gender</span></span><br><span class="line">])-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="field-字段筛选"><a href="#field-字段筛选" class="headerlink" title="field()字段筛选"></a>field()字段筛选</h3><ul>
<li><p>使用 <strong>field()</strong> 方法，可以指定要查询的字段；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字段筛选</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">field</span>(<span class="string">&quot;id, age, gender&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">field</span>([<span class="string">&quot;id, age, gender&quot;</span>])-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>field()</strong> 方法，给指定的字段设置别名；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字段别名</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">field</span>(<span class="string">&quot;id, gender as sex&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">field</span>([<span class="string">&quot;id&quot;</span>, <span class="string">&quot;gender&quot;</span>=&gt;<span class="string">&quot;sex&quot;</span>])-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <strong>fieldRaw()</strong> 方法里，可以直接给字段设置 MySQL 函数；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接SQL函数</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">fieldRaw</span>(<span class="string">&quot;id, UPPER(details)&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">field</span>(<span class="literal">true</span>)-&gt;<span class="title function_ invoke__">select</span>();   <span class="comment">// 推荐</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Db</span>::<span class="title function_ invoke__">getLastSql</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>withoutField()</strong> 方法中字段排除，可以屏蔽掉想要不显示的字段；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 排除字段</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">withoutField</span>(<span class="string">&quot;details&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>field()</strong> 方法在新增时，验证字段的合法性；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 排除新增字段</span></span><br><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">field</span>(<span class="string">&quot;name,age,gender&quot;</span>)-&gt;<span class="title function_ invoke__">insert</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="常用链式方法"><a href="#常用链式方法" class="headerlink" title="常用链式方法"></a><strong>常用链式方法</strong></h3><ul>
<li><p>使用 <strong>alias()</strong> 方法，给数据库起一个别名；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给数据库起个别名</span></span><br><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">alias</span>(<span class="string">&quot;a&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Db</span>::<span class="title function_ invoke__">getLastSql</span>();</span><br><span class="line"><span class="comment">// 起别名最主要是和另一张表进行关联，这里看手册好了，没表测试</span></span><br><span class="line"><span class="title function_ invoke__">alias</span>(<span class="string">&quot;a&quot;</span>)-&gt;<span class="title function_ invoke__">join</span>()</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>limit()</strong> 方法，限制获取输出数据的个数；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 显示前5条</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">limit</span>(<span class="number">5</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>分页模式，即传递两个参数，比如从第 3 条开始显示 5 条 limit(2,5)；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从第2个位置，也就是第3条开始，显示5条</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">limit</span>(<span class="number">2</span>,<span class="number">5</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="comment">// 查询第一页数据，1至10条</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">page</span>(<span class="number">1</span>,<span class="number">10</span>)-&gt;<span class="title function_ invoke__">select</span>(); </span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>order()</strong> 方法，可以指定排序方式，没有指定第二参数，默认 asc；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按id倒序排列</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">order</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;desc&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>支持数组的方式，对多个字段进行排序；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按多个字段规则排序</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">order</span>([<span class="string">&quot;age&quot;</span>=&gt;<span class="string">&quot;asc&quot;</span>, <span class="string">&quot;id&quot;</span>=&gt;<span class="string">&quot;desc&quot;</span>])-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="comment">//支持 orderRaw() 方法，可以传入SQL函数，和前面各类Raw一样，不再赘述</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>group()</strong> 方法，给性别不同的人进行 age 字段的总和统计；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 统计性别的年龄总和</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">fieldRaw</span>(<span class="string">&quot;gender, SUM(age)&quot;</span>)</span><br><span class="line">                        -&gt;<span class="title function_ invoke__">group</span>(<span class="string">&quot;gender&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>group()</strong> 分组之后，再使用 <strong>having()</strong> 进行筛选；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 统计性别的年龄总和，筛选大于100的</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">fieldRaw</span>(<span class="string">&quot;gender, SUM(age)&quot;</span>)</span><br><span class="line">                        -&gt;<span class="title function_ invoke__">group</span>(<span class="string">&quot;gender&quot;</span>)</span><br><span class="line">                        -&gt;<span class="title function_ invoke__">having</span>(<span class="string">&quot;SUM(age) &gt; 100&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="时间查询"><a href="#时间查询" class="headerlink" title="时间查询"></a><strong>时间查询</strong></h3><ul>
<li><p>可以使用 &gt;、&lt;、&gt;&#x3D;、&lt;&#x3D; 来筛选匹配时间的数据；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统时间筛选</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;2022-1-1&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;between&quot;</span>, [<span class="string">&quot;2020-1-1&quot;</span>, <span class="string">&quot;2023-1-1&quot;</span>])-&gt;<span class="title function_ invoke__">select</span>(); </span><br></pre></td></tr></table></figure>
</li>
<li><p>快捷方式 <strong>whereTime</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用快捷方式查询</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereTime</span>(<span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;&gt;=&quot;</span>, <span class="string">&quot;2022-1-1&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认是 &gt; 可以省略</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereTime</span>(<span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;2022-1-1&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>区间查询快捷方式 <strong>whereBetweenTime</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 区间查询，包含 whereNotBetweenTime</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereBetweenTime</span>(<span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;2020-1-1&quot;</span>, <span class="string">&quot;2023-1-1&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>whereYear</strong> 查询今年的数据、去年的数据和某一年的数据；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询今年</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereYear</span>(<span class="string">&quot;create_time&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="comment">// 查询去年</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereYear</span>(<span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;last year&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="comment">// 查询某一年</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereYear</span>(<span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;2019&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>whereMonth</strong> 查询当月的数据、上月的数据和某一个月的数据；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereMonth</span>(<span class="string">&quot;create_time&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereMonth</span>(<span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;last month&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereMonth</span>(<span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;2020-6&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>whereDay</strong> 查询今天的数据、昨天的数据和某一个天的数据；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereDay</span>(<span class="string">&quot;create_time&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereDay</span>(<span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;last day&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereDay</span>(<span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;2020-6-27&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询指定时间的数据，比如两小时内的；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 两小时内的</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereTime</span>(<span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;-2 hours&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询两个时间字段时间有效期的数据，比如活动开始到结束的期间；</p>
</li>
<li><p>比如创建两个字段：start_time，end_time，注册后，分别写入对应时间表明它的有效期；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接这么写，不太好理解，看手册的另一种普通写法很容易理解</span></span><br><span class="line"><span class="comment">// 实战中，字段丰富的时候再演示</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereBetweenTimeField</span>(<span class="string">&quot;start_time&quot;</span>, <span class="string">&quot;end_time&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a><strong>聚合查询</strong></h3><ul>
<li><p>使用 <strong>count()</strong> 方法，可以求出所查询数据的数量；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取记录数</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">count</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>count()</strong> 可设置指定 id，比如有空值(Null)的 details，不会计算数量；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 值NULL不计数</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">count</span>(<span class="string">&quot;details&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>max()</strong> 方法，求出所查询数据字段的最大值；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 求最大年龄</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">max</span>(<span class="string">&quot;age&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果 <strong>max()</strong> 方法，求出的值不是数值，则通过第二参数强制转换；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果最大值不是数值，false关闭强制转换</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">max</span>(<span class="string">&quot;name&quot;</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>min()</strong> 方法，求出所查询数据字段的最小值，也可以强制转换；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 求最小值</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">min</span>(<span class="string">&quot;age&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>avg()</strong> 方法，求出所查询数据字段的平均值；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 求平均值</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">avg</span>(<span class="string">&quot;age&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>sum()</strong> 方法，求出所查询数据字段的总和；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 求总和</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">sum</span>(<span class="string">&quot;age&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a><strong>子查询</strong></h3><ul>
<li><p>使用 <strong>fetchSql()</strong> 方法，传递参数true时，可以设置不执行 SQL，直接返回SQL语句；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子查询语句</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">fetchSql</span>(<span class="literal">true</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>buildSql()</strong> 方法，也是返回 SQL 语句，不需要再执行 select()，且有括号；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第二种子查询</span></span><br><span class="line"><span class="variable">$subQuery</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">buildSql</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>结合以上方法，我们实现一个子查询；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子查询样式</span></span><br><span class="line"><span class="variable">$subQuery</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">field</span>(<span class="string">&quot;id&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;age&quot;</span>,<span class="string">&quot;&gt;&quot;</span>, <span class="number">18</span>)-&gt;<span class="title function_ invoke__">buildSql</span>();</span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereExp</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;IN &quot;</span>.<span class="variable">$subQuery</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用闭包的方式执行子查询；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 采用闭包构建子查询</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;IN&quot;</span>, function (<span class="variable">$query</span>) &#123;</span><br><span class="line">    <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">field</span>(<span class="string">&quot;id&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;age&quot;</span>,<span class="string">&quot;&gt;&quot;</span>, <span class="number">18</span>);</span><br><span class="line">&#125;)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="原生查询"><a href="#原生查询" class="headerlink" title="原生查询"></a><strong>原生查询</strong></h3><ul>
<li><p>使用 <strong>query()</strong> 方法，进行原生 SQL 查询，适用于读取操作，SQL 错误返回 false；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生SQL</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">query</span>(<span class="string">&quot;SELECT * FROM tp_user&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>execute</strong> 方法，进行原生 SQL 更新写入等，SQL 错误返回 false；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生更新写入</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">execute</span>(<span class="string">&quot;update tp_user set details=&quot;</span>快快快来救我！<span class="string">&quot; where id=5&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="列字段快捷查询"><a href="#列字段快捷查询" class="headerlink" title="列字段快捷查询"></a><strong>列字段快捷查询</strong></h3><ul>
<li><p>之前用过诸如：whereIn、whereExp、whereLike等等快捷查询；</p>
</li>
<li><p>所有快捷查询列表的手册位置：数据库 -&gt; 查询构造器 -&gt; 高级查询中，找到快捷查询表格；</p>
</li>
<li><p><strong>whereColumn()</strong> 方法，比较两个字段的值，符合的就筛选出来；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字段比较，id大于age</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereColumn</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;age&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="comment">// 如果是 等于判断 可以简化</span></span><br><span class="line">-&gt;<span class="title function_ invoke__">whereColumn</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;age&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>whereFieldName()</strong> 方法，查询某个字段的值，注意 FileName 是字段名；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取所有性别为：男</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereGender</span>(<span class="string">&quot;男&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取名字叫王二狗的信息</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereName</span>(<span class="string">&quot;王二狗&quot;</span>)-&gt;<span class="title function_ invoke__">find</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>getByFieldName()</strong> 方法，查询某个字段的值，注意只能查询一条，不需要 **find()**；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单条数据</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">getByName</span>(<span class="string">&quot;王二狗&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>getFieldByFieldName()</strong> 方法，通过查询得到某个指定字段的单一值；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询单条并返回单列，找出王二狗的年龄</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">getFieldByName</span>(<span class="string">&quot;王二狗&quot;</span>, <span class="string">&quot;age&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="条件查询"><a href="#条件查询" class="headerlink" title="条件查询"></a><strong>条件查询</strong></h3><ul>
<li><p><strong>when()</strong> 可以通过条件判断，执行闭包里的分支查询；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 条件判断</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">when</span>(<span class="literal">false</span>, function (<span class="variable">$query</span>) &#123;</span><br><span class="line">    <span class="comment">// 满足条件执行这段SQL</span></span><br><span class="line">    <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="number">5</span>);</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$query</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 不满足条件执行这段SQL</span></span><br><span class="line">    <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;&lt;=&quot;</span>, <span class="number">5</span>);</span><br><span class="line">&#125;)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<p>第一个参数 <code>false</code> 是条件，如果该条件为 <code>true</code>，则执行第一个匿名函数，否则执行第二个匿名函数。</p>
<h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><ul>
<li><p>数据库的表引擎需要是 InnoDB 才可以使用，如果不是调整即可；</p>
</li>
<li><p>事务处理，需要执行多个 SQL 查询，数据是关联恒定的；</p>
</li>
<li><p>如果成功一条查询，改变了数据，而后一条失败，则前面的数据回滚；</p>
</li>
<li><p>比如：银行取钱，银行ATM扣了1000，但入口被卡住，你没拿到，这时需要事务处理；</p>
</li>
<li><p>系统提供了两种事务处理的方式，第一种是自动处理，出错自动回滚；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 出现异常回滚</span></span><br><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">transaction</span>(function () &#123;</span><br><span class="line">    <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">delete</span>(<span class="number">12</span>);</span><br><span class="line">    <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">findOrFail</span>(<span class="number">13</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>手动处理，基本和原生处理类似，可以自行输出错误信息；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动事务</span></span><br><span class="line"><span class="title class_">Db</span>::<span class="title function_ invoke__">startTrans</span>();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">delete</span>(<span class="number">12</span>);</span><br><span class="line">    <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">findOrFail</span>(<span class="number">13</span>);</span><br><span class="line">    <span class="comment">//提交事务</span></span><br><span class="line">    <span class="title class_">Db</span>::<span class="title function_ invoke__">commit</span>();</span><br><span class="line">&#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;执行SQL失败！&quot;</span>;</span><br><span class="line">    <span class="comment">// 回滚</span></span><br><span class="line">    <span class="title class_">Db</span>::<span class="title function_ invoke__">rollback</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="获取器"><a href="#获取器" class="headerlink" title="获取器"></a>获取器</h3><ul>
<li><p>获取器的意思就是：将数据的字段进行转换处理再进行操作；</p>
</li>
<li><p>比如在获取数据列表的时候，将获取到的详情字段全部大写；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取器改变字段值</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">withAttr</span>(<span class="string">&quot;details&quot;</span>, function (<span class="variable">$value</span>, <span class="variable">$data</span>) &#123;</span><br><span class="line">    <span class="comment">// NULL 不处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$value</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>withAttr也是支持JSON字段的，具体参考手册 查询构造器 -&gt; 获取器；</p>
</li>
</ul>
<h2 id="高级查询"><a href="#高级查询" class="headerlink" title="高级查询"></a>高级查询</h2><h3 id="索引关联"><a href="#索引关联" class="headerlink" title="索引关联"></a><strong>索引关联</strong></h3><ul>
<li><p><strong>where</strong> 方法的数组查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 性别男，年龄大于15岁，常规做法</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;age&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="number">15</span>)</span><br><span class="line">                        -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;gender&quot;</span>, <span class="string">&quot;男&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 索引数组方式，二维数组，返回的SQL 是一条 AND 并列关系</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>([</span><br><span class="line">    [<span class="string">&quot;age&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;15&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;gender&quot;</span>,<span class="string">&quot;=&quot;</span>, <span class="string">&quot;男&quot;</span>]</span><br><span class="line">])-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果是等于，可以直接用关联数组，一维</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>([</span><br><span class="line">    <span class="string">&quot;age&quot;</span>     =&gt;  <span class="number">15</span>,</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>  =&gt;  <span class="string">&quot;男&quot;</span></span><br><span class="line">])-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 两种模式结合起来，</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>([</span><br><span class="line">    [<span class="string">&quot;age&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;15&quot;</span>],</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>  =&gt;  <span class="string">&quot;男&quot;</span></span><br><span class="line">])-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 搜索条件独立管理，这里=号写全</span></span><br><span class="line"><span class="variable">$map</span>[] = [<span class="string">&quot;age&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;15&quot;</span>];</span><br><span class="line"><span class="variable">$map</span>[] = [<span class="string">&quot;gender&quot;</span>,<span class="string">&quot;=&quot;</span>, <span class="string">&quot;男&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="variable">$map</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="拼装查询"><a href="#拼装查询" class="headerlink" title="拼装查询"></a><strong>拼装查询</strong></h3><ul>
<li><p>使用 <strong>|(OR)</strong> 或 <strong>&amp;(AND)</strong> 来实现 where 条件的高级查询，where 支持多个连缀；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// or和and 拼装查询</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;name|details&quot;</span>, <span class="string">&quot;like&quot;</span>, <span class="string">&quot;%王%&quot;</span>)</span><br><span class="line">						-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&amp;create_time&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="number">0</span>)</span><br><span class="line">    					-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拼装返回的SQL</span></span><br><span class="line">SELECT * FROM `tp_user` <span class="title function_ invoke__">WHERE</span> ( `name` LIKE <span class="string">&quot;%王%&quot;</span> OR `details` LIKE <span class="string">&quot;%王%&quot;</span> ) <span class="title function_ invoke__">AND</span> ( `id` &gt; <span class="number">0</span> AND `create_time` &gt; <span class="string">&quot;0&quot;</span> )</span><br></pre></td></tr></table></figure>
</li>
<li><p>索引数组方式，可以在 where 进行多个字段进行查询；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 索引数组拼装</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>([</span><br><span class="line">    [<span class="string">&quot;id&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;5&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;gender&quot;</span>, <span class="string">&quot;=&quot;</span>, <span class="string">&quot;女&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;age&quot;</span>, <span class="string">&quot;&lt;=&quot;</span>, <span class="number">15</span>],</span><br><span class="line">    [<span class="string">&quot;details&quot;</span>, <span class="string">&quot;like&quot;</span>, <span class="string">&quot;%我%&quot;</span>]</span><br><span class="line">])-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拼装返回的SQL</span></span><br><span class="line">SELECT * FROM `tp_user` WHERE `id` &gt; <span class="number">5</span> AND `gender` = <span class="string">&quot;女&quot;</span> AND `age` &lt;= <span class="number">15</span> AND `details` LIKE <span class="string">&quot;%我%&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>条件字符串复杂组装，比如使用 exp 了，就使用 <strong>raw()</strong> 方法；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exp 拼装</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>([</span><br><span class="line">    [<span class="string">&quot;gender&quot;</span>, <span class="string">&quot;=&quot;</span>, <span class="string">&quot;男&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;age&quot;</span>, <span class="string">&quot;exp&quot;</span>, <span class="title class_">Db</span>::<span class="title function_ invoke__">raw</span>(<span class="string">&quot;&gt;=10 AND id&lt;5&quot;</span>)]</span><br><span class="line">])-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拼装返回的SQL</span></span><br><span class="line">SELECT * FROM `tp_user` WHERE `gender` = <span class="string">&quot;男&quot;</span> <span class="title function_ invoke__">AND</span> ( `age` &gt;=<span class="number">10</span> AND id&lt;<span class="number">5</span> )</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果有多个where，并需要控制优先级，那么可以在需要的部分加上中括号；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下面的代码无法控制优先级</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>([</span><br><span class="line">    [<span class="string">&quot;gender&quot;</span>, <span class="string">&quot;=&quot;</span>, <span class="string">&quot;男&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;age&quot;</span>, <span class="string">&quot;exp&quot;</span>, <span class="title class_">Db</span>::<span class="title function_ invoke__">raw</span>(<span class="string">&quot;&gt;=10 AND id&lt;5&quot;</span>)]</span><br><span class="line">])-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;details&quot;</span>, <span class="string">&quot;like&quot;</span>, <span class="string">&quot;%我%&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 外加一个中括号</span></span><br><span class="line">-&gt;<span class="title function_ invoke__">where</span>([[</span><br><span class="line">    ...</span><br><span class="line">]])</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 拼装返回的SQL</span></span><br><span class="line">SELECT * FROM `tp_user` <span class="title function_ invoke__">WHERE</span> ( `gender` = <span class="string">&quot;男&quot;</span> <span class="title function_ invoke__">AND</span> ( `age` &gt;=<span class="number">10</span> AND id&lt;<span class="number">5</span> ) ) AND `details` LIKE <span class="string">&quot;%我%&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 推荐用变量代替</span></span><br><span class="line"><span class="variable">$map</span> =[</span><br><span class="line">    [<span class="string">&quot;gender&quot;</span>, <span class="string">&quot;=&quot;</span>, <span class="string">&quot;男&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;age&quot;</span>, <span class="string">&quot;exp&quot;</span>, <span class="title class_">Db</span>::<span class="title function_ invoke__">raw</span>(<span class="string">&quot;&gt;=10 AND id&lt;5&quot;</span>)]</span><br><span class="line">];</span><br><span class="line">-&gt;<span class="title function_ invoke__">where</span>([<span class="variable">$map</span>])</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果，条件中有多次出现一个字段，并且需要 OR 来左右筛选，可以用 <strong>whereOr</strong>；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多条件重复字段 OR 选项</span></span><br><span class="line"><span class="variable">$map1</span> = [</span><br><span class="line">    [<span class="string">&quot;name&quot;</span>, <span class="string">&quot;like&quot;</span>, <span class="string">&quot;%王%&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;details&quot;</span>, <span class="string">&quot;=&quot;</span>, <span class="literal">null</span>]</span><br><span class="line">];</span><br><span class="line"><span class="variable">$map2</span> = [</span><br><span class="line">    [<span class="string">&quot;gender&quot;</span>, <span class="string">&quot;=&quot;</span>, <span class="string">&quot;女&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;details&quot;</span>, <span class="string">&quot;exp&quot;</span>, <span class="title class_">Db</span>::<span class="title function_ invoke__">raw</span>(<span class="string">&quot;IS NOT NULL&quot;</span>)]</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">name</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">whereOr</span>([<span class="variable">$map1</span>, <span class="variable">$map2</span>])-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拼装返回的SQL</span></span><br><span class="line">SELECT * FROM `tp_user` <span class="title function_ invoke__">WHERE</span> ( `name` LIKE <span class="string">&quot;%王%&quot;</span> AND `details` IS <span class="literal">NULL</span> ) <span class="title function_ invoke__">OR</span> ( `gender` = <span class="string">&quot;女&quot;</span> <span class="title function_ invoke__">AND</span> ( `details` IS NOT <span class="literal">NULL</span> ) )</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h1><h2 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h2><h3 id="定义模型"><a href="#定义模型" class="headerlink" title="定义模型"></a><strong>定义模型</strong></h3><ul>
<li><p>为了避免被前面课程中控制器的类名干扰，删除或改名都行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserBak.php，目前不存在任何地方的User.php了</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserBak</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>定义一个和数据库表相匹配的模型，可在app应用目录下创建model文件夹；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>模型会自动对应数据表，并且有一套自己的命名规则；</p>
</li>
<li><p>模型类需要去除表前缀(tp_)，采用驼峰式命名，并且首字母大写；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">tp_user</span>(表名) =&gt; User</span><br><span class="line"><span class="title function_ invoke__">tp_user_type</span>(表名) =&gt; UserType</span><br></pre></td></tr></table></figure>
</li>
<li><p>在控制器段创建一个任意名称的类，当然有语义更好，但为了教学理解起名为：TestUser.php；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">model</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：类名不限制</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestUser</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="title class_">User</span>::<span class="title function_ invoke__">select</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="模型设置"><a href="#模型设置" class="headerlink" title="模型设置"></a><strong>模型设置</strong></h3><ul>
<li><p>系统会自动识别 <strong>模型类名</strong> 对应 <strong>表名</strong>，User.php  对应 user 表（不含前缀）；</p>
</li>
<li><p>但如果你的模型类名不是按照规则对应表名，则需要通过成员字段去设置；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Abc</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 设置表名</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$name</span> = <span class="string">&quot;user&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用$table时，指定表时需要完整的表名：tp_user</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>系统也会默认id为你的主键名，如果不是id，则需要设置；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置主键</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$pk</span> = <span class="string">&quot;uid&quot;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>模型支持初始化功能，需要设置静态方法，并只在第一次实例化的时候执行，且只执行一次；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;初始化&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="新增和删除"><a href="#新增和删除" class="headerlink" title="新增和删除"></a>新增和删除</h2><h3 id="新增操作"><a href="#新增操作" class="headerlink" title="新增操作"></a><strong>新增操作</strong></h3><ul>
<li><p>用模型新增数据，首先要实例化模型，开发工具会补全use，非集成工具别忘了；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">model</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 手册new User，这里括号是工具补全的，都可以</span></span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用实例化的方式添加一条数据，并使用 <strong>save()</strong> 方法进行保存；</p>
</li>
<li><p>注意：使用模型时，会自动给时间字段 <strong>create_time</strong>，<strong>update_time</strong>（要有该字段）写入当前时间；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line"><span class="variable">$user</span>-&gt;name = <span class="string">&quot;李白&quot;</span>;</span><br><span class="line"><span class="variable">$user</span>-&gt;age = <span class="number">28</span>;</span><br><span class="line"><span class="variable">$user</span>-&gt;gender = <span class="string">&quot;男&quot;</span>;</span><br><span class="line"><span class="variable">$user</span>-&gt;details = <span class="string">&quot;床前明月光，好诗！&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 成功返回true，失败抛异常，其它看手册</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>也可以通过 <strong>save()</strong> 传递数据数组的方式，来新增数据；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">save</span>([</span><br><span class="line">    <span class="string">&quot;name&quot;</span>  =&gt;  <span class="string">&quot;杜甫&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>   =&gt;  <span class="number">19</span>,</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>  =&gt;  <span class="string">&quot;男&quot;</span>,</span><br><span class="line">    <span class="string">&quot;details&quot;</span> =&gt;  <span class="string">&quot;一行白鹭上青天，好诗！&quot;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>allowField()</strong> 方法，允许要写入的字段，其它字段就无法写入了；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">allowField</span>([<span class="string">&quot;name&quot;</span>,<span class="string">&quot;age&quot;</span>,<span class="string">&quot;gender&quot;</span>])-&gt;<span class="title function_ invoke__">save</span>([</span><br><span class="line">    <span class="string">&quot;name&quot;</span>  =&gt;  <span class="string">&quot;蒲松龄&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>   =&gt;  <span class="number">25</span>,</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>  =&gt;  <span class="string">&quot;男&quot;</span>,</span><br><span class="line">    <span class="string">&quot;details&quot;</span> =&gt;  <span class="string">&quot;十里平湖霜满天，好诗！&quot;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>模型新增也提供了 <strong>replace()</strong> 方法来实现 <strong>REPLACE into</strong> 新增；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">replace</span>()-&gt;<span class="title function_ invoke__">save</span>([</span><br><span class="line">    <span class="string">&quot;id&quot;</span>    =&gt;  <span class="number">15</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>  =&gt;  <span class="string">&quot;蒲松龄&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>   =&gt;  <span class="number">25</span>,</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>  =&gt;  <span class="string">&quot;男&quot;</span>,</span><br><span class="line">    <span class="string">&quot;details&quot;</span> =&gt;  <span class="string">&quot;十里平湖霜满天，好诗！&quot;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>当新增成功后，使用 <strong>$user-&gt;id</strong> ，可以获得自增 ID（主键需是 id）；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="variable">$user</span>-&gt;id;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 saveAll()方法，可以批量新增数据，返回批量新增的数组；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">saveAll</span>([</span><br><span class="line">    [</span><br><span class="line">        <span class="string">&quot;name&quot;</span>  =&gt;  <span class="string">&quot;赵六&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span>   =&gt;  <span class="number">19</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>=&gt;  <span class="string">&quot;男&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">&quot;name&quot;</span>  =&gt;  <span class="string">&quot;钱七&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span>   =&gt;  <span class="number">22</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>=&gt;  <span class="string">&quot;男&quot;</span>,</span><br><span class="line">        <span class="string">&quot;details&quot;</span>   =&gt;  <span class="string">&quot;我很有钱，排行老七！&quot;</span></span><br><span class="line">    ]</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>::create()</strong> 静态方法，来创建要新增的数据；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">create</span>([</span><br><span class="line">    <span class="string">&quot;name&quot;</span>  =&gt;  <span class="string">&quot;李逍遥&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>   =&gt;  <span class="number">18</span>,</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>=&gt;  <span class="string">&quot;男&quot;</span>,</span><br><span class="line">    <span class="string">&quot;details&quot;</span>   =&gt;  <span class="string">&quot;我是一代主角！&quot;</span></span><br><span class="line">], [<span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>, <span class="string">&quot;gender&quot;</span>, <span class="string">&quot;details&quot;</span>], <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//参数 1 是新增数据数组，必选</span></span><br><span class="line"><span class="comment">//参数 2 是允许写入的字段，可选</span></span><br><span class="line"><span class="comment">//参数 3 为是否 replace 写入，可选，默认 false 为 Insert 写入</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$user</span>-&gt;id;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="删除操作"><a href="#删除操作" class="headerlink" title="删除操作"></a><strong>删除操作</strong></h3><ul>
<li><p>使用 find() 方法，通过主键 (id) 查询到想要删除的数据；</p>
</li>
<li><p>然后再通过 delete()方法，将数据删除，返回布尔值；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据主键值，删除数据</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">20</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">delete</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>也可以使用静态方法调用 destroy()方法，通过主键(id)删除数据；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单条删除</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">User</span>::<span class="title function_ invoke__">destroy</span>(<span class="number">21</span>);</span><br><span class="line"><span class="comment">// 批量删除</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">User</span>::<span class="title function_ invoke__">destroy</span>([<span class="number">22</span>, <span class="number">33</span>, <span class="number">44</span>]);</span><br><span class="line"><span class="comment">// 条件删除</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">User</span>::<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="number">15</span>)-&gt;<span class="title function_ invoke__">delete</span>();（返回删除的条目数）</span><br></pre></td></tr></table></figure>
</li>
<li><p>destroy() 方法，使用闭包的方式进行删除；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 闭包模式</span></span><br><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">destroy</span>(function (<span class="variable">$query</span>) &#123;</span><br><span class="line">    <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="number">15</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><h3 id="数据更新"><a href="#数据更新" class="headerlink" title="数据更新"></a><strong>数据更新</strong></h3><ul>
<li><p>使用 find()方法获取数据，然后通过 save()方法保存修改，返回布尔值；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">19</span>);</span><br><span class="line"><span class="variable">$user</span>-&gt;details = <span class="string">&quot;我是一代主角！&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过 where()方法结合 find()方法的查询条件获取的数据，进行修改；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">where</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;李逍遥&quot;</span>)-&gt;<span class="title function_ invoke__">find</span>();</span><br><span class="line"><span class="variable">$user</span>-&gt;details = <span class="string">&quot;我想做二代主角！&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>save()方法只会更新变化的数据，如果提交的修改数据没有变化，则不更新；</p>
</li>
<li><p>但如果你想强制更新数据，即使数据一样，那么可以使用 force()方法；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如何验证被强制了，查看update_time字段是否更新了</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">force</span>()-&gt;<span class="title function_ invoke__">save</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>Db::raw()执行 SQL 函数的方式，同样在这里有效；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span>-&gt;age = <span class="title class_">Db</span>::<span class="title function_ invoke__">raw</span>(<span class="string">&quot;age + 2&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>关于验证过滤，后续学习Request再说，手册中 模型 -&gt; 更新 里也有说明：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">allowField</span>([<span class="string">&quot;name&quot;</span>,<span class="string">&quot;age&quot;</span>])-&gt;<span class="title function_ invoke__">save</span>(...)</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过 saveAll()方法，可以批量修改数据，返回被修改的数据集合；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> <span class="title class_">User</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">saveAll</span>([</span><br><span class="line">    [<span class="string">&quot;id&quot;</span>=&gt;<span class="number">17</span>, <span class="string">&quot;gender&quot;</span>=&gt;<span class="string">&quot;女&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;id&quot;</span>=&gt;<span class="number">18</span>, <span class="string">&quot;gender&quot;</span>=&gt;<span class="string">&quot;女&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;id&quot;</span>=&gt;<span class="number">19</span>, <span class="string">&quot;gender&quot;</span>=&gt;<span class="string">&quot;女&quot;</span>],</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用静态方法::update()更新，返回的是对象实例；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title class_">User</span>::<span class="title function_ invoke__">update</span>([<span class="string">&quot;id&quot;</span>=&gt;<span class="number">17</span>, <span class="string">&quot;gender&quot;</span>=&gt;<span class="string">&quot;男&quot;</span>]);</span><br><span class="line"><span class="comment">// ID放在后面，返回数据不含ID</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">User</span>::<span class="title function_ invoke__">update</span>([<span class="string">&quot;gender&quot;</span>=&gt;<span class="string">&quot;男&quot;</span>], [<span class="string">&quot;id&quot;</span>=&gt;<span class="number">18</span>]);</span><br><span class="line"><span class="comment">// 限制更新的内容，只允许gender被修改</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">User</span>::<span class="title function_ invoke__">update</span>([<span class="string">&quot;gender&quot;</span>=&gt;<span class="string">&quot;男&quot;</span>, <span class="string">&quot;name&quot;</span>=&gt;<span class="string">&quot;可笑的人&quot;</span>], [<span class="string">&quot;id&quot;</span>=&gt;<span class="number">19</span>], [<span class="string">&quot;gender&quot;</span>]);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><p>其实和数据库的查询大差不差</p>
<h3 id="模型的查询"><a href="#模型的查询" class="headerlink" title="模型的查询"></a><strong>模型的查询</strong></h3><ul>
<li><p>模型的绝大部分语法基本都来自于 <strong>Db::name()</strong> 的查询：</p>
</li>
<li><p>在手册 模型 -&gt; 查询 中可以查阅，这里就演示几个常用的意思一下：</p>
</li>
<li><p><strong>find()</strong> 单个 和 <strong>select()</strong> 多个;</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">select</span>([<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>也可以使用 where()方法进行条件筛选查询数据；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;&lt;&quot;</span>, <span class="number">5</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;thinkphp&#x27;</span>)-&gt;<span class="title function_ invoke__">find</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>模型方法也可以使用 where 等连缀查询，和数据库查询方式一样；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">limit</span>(<span class="number">3</span>)-&gt;<span class="title function_ invoke__">order</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;desc&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>模型支持聚合查询：max、min、sum、count、avg 等；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">count</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>模型也支持大量的快捷方式，这里演示一个：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">whereLike</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;%王%&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="模型的字段设置"><a href="#模型的字段设置" class="headerlink" title="模型的字段设置"></a>模型的字段设置</h2><h3 id="字段设置"><a href="#字段设置" class="headerlink" title="字段设置"></a><strong>字段设置</strong></h3><ul>
<li><p>模型的数据字段和表字段是对应关系，默认会自动获取，包括字段的类型；</p>
</li>
<li><p>自动获取会导致增加一次查询，如果在模型中配置字段信息，会减少内存开销；</p>
</li>
<li><p>可以在模型设置$schema 字段，明确定义字段信息，字段需要对应表写完整；</p>
</li>
<li><p>字段类型的定义可以使用PHP类型或者数据库的字段类型都可以，以便自动绑定类型；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置字段信息，需要写完整的数据表字段</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$schema</span> = [</span><br><span class="line">    <span class="string">&quot;id&quot;</span>    =&gt;  <span class="string">&quot;int&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>  =&gt;  <span class="string">&quot;string&quot;</span>,</span><br><span class="line">    ...</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置模型字段，只能对模型有效，对于 Db::name() 查询无法作用。</p>
</li>
<li><p>要让模型和Db查询都支持字段类型设置，分三步：</p>
<ul>
<li><p>把上面的$schema先注释掉；</p>
</li>
<li><p>在 config&#x2F;database.php 开启缓存字段；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开启字段缓存</span></span><br><span class="line"><span class="string">&quot;fields_cache&quot;</span>    =&gt; <span class="literal">true</span>,</span><br></pre></td></tr></table></figure>
</li>
<li><p>在根目录命令行执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think optimize:schema</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="废弃字段"><a href="#废弃字段" class="headerlink" title="废弃字段"></a><strong>废弃字段</strong></h3><ul>
<li><p>由于历史遗留问题，我们不再想使用某些字段，可以在模型里设置；</p>
</li>
<li><p>设置后，我们在查询和写入时将忽略这些字段；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置废弃字段</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$disuse</span> = [<span class="string">&quot;age&quot;</span>, <span class="string">&quot;details&quot;</span>];</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="只读字段"><a href="#只读字段" class="headerlink" title="只读字段"></a><strong>只读字段</strong></h3><ul>
<li><p>只读字段用来保护某些特殊的字段值不被更改，这个字段的值一旦写入，就无法更改；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置只读字段</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$readonly</span> = [<span class="string">&quot;age&quot;</span>, <span class="string">&quot;details&quot;</span>];</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后在控制器端进行修改测试：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改查看只读字段</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">User</span>::<span class="title function_ invoke__">update</span>([<span class="string">&quot;id&quot;</span>=&gt;<span class="number">19</span>, <span class="string">&quot;age&quot;</span>=&gt;<span class="number">22</span>, <span class="string">&quot;name&quot;</span>=&gt;<span class="string">&quot;李逍遥2&quot;</span>, <span class="string">&quot;details&quot;</span>=&gt;<span class="string">&quot;可笑&quot;</span>]);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="获取器和修改器"><a href="#获取器和修改器" class="headerlink" title="获取器和修改器"></a>获取器和修改器</h2><h3 id="获取器-1"><a href="#获取器-1" class="headerlink" title="获取器"></a><strong>获取器</strong></h3><ul>
<li><p>获取器的作用是对模型实例的数据做出自动处理；</p>
</li>
<li><p>一个获取器对应模型的一个特殊方法，该方法为 public；</p>
</li>
<li><p>方法名的命名规范为：<strong>getFieldAttr</strong>()；</p>
</li>
<li><p>举个例子，数据库表示状态 status 字段采用的是数值；</p>
</li>
<li><p>而页面上，我们需要输出 status 字段希望是中文，就可以使用获取器；</p>
</li>
<li><p>在 User 模型端，我创建一个对外的方法，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取器，改变字段的值</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getStatusAttr</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$status</span> = [-<span class="number">1</span>=&gt;<span class="string">&quot;删除&quot;</span>, <span class="number">0</span>=&gt;<span class="string">&quot;冻结&quot;</span>, <span class="number">1</span>=&gt;<span class="string">&quot;正常&quot;</span>, <span class="number">2</span>=&gt;<span class="string">&quot;待审核&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$status</span>[<span class="variable">$value</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>控制器端，正常输出数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">attr</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">select</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$user</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果你定义了获取器，并且想获取原始值，可以使用 getData()方法；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">getData</span>(<span class="string">&quot;status&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 withAttr 在控制器端实现动态获取器，比如让年龄+100岁；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可以传入参数二 $data，获得所有数据，方便数据获取和判断</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">select</span>()-&gt;<span class="title function_ invoke__">withAttr</span>(<span class="string">&quot;age&quot;</span>, function(<span class="variable">$value</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span> + <span class="number">100</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="修改器"><a href="#修改器" class="headerlink" title="修改器"></a><strong>修改器</strong></h3><ul>
<li><p>模型修改器的作用，就是对模型设置对象的值进行处理；</p>
</li>
<li><p>比如，我们要新增数据的时候，对数据就行格式化、过滤、转换等处理；</p>
</li>
<li><p>模型修改器的命名规则为：<strong>setFieldAttr</strong>；</p>
</li>
<li><p>我们要设置一个新增，规定输入的年龄都自动+100岁，修改器如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改器，写入时改变字段的值</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setAgeAttr</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span> + <span class="number">100</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title class_">User</span>::<span class="title function_ invoke__">create</span>([</span><br><span class="line">    <span class="string">&quot;name&quot;</span>  =&gt;  <span class="string">&quot;酒剑仙&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>   =&gt;  <span class="number">58</span>,</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>=&gt;  <span class="string">&quot;男&quot;</span>,</span><br><span class="line">    <span class="string">&quot;details&quot;</span>   =&gt;  <span class="string">&quot;我是隐藏主角！&quot;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>除了新增，会调用修改器，修改更新也会触发修改器；</p>
</li>
<li><p>模型修改器只对模型方法有效，调用数据库的方法是无效的，比如-&gt;insert();</p>
</li>
</ul>
<h2 id="搜索器和自动时间戳"><a href="#搜索器和自动时间戳" class="headerlink" title="搜索器和自动时间戳"></a>搜索器和自动时间戳</h2><h3 id="搜索器"><a href="#搜索器" class="headerlink" title="搜索器"></a><strong>搜索器</strong></h3><ul>
<li><p>搜索器是用于封装字段（或搜索标识）的查询表达式，类似查询范围；</p>
</li>
<li><p>一个搜索器对应模型的一个特殊方法，该方法为 public；</p>
</li>
<li><p>方法名的命名规范为：**searchFieldAttr()**；</p>
</li>
<li><p>举个例子，我们要封装一个 <strong>name</strong> 字段的模糊查询，然后封装一个时间限定查询；</p>
</li>
<li><p>在 User 模型端，我创建两个对外的方法，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 搜索器，模糊查找姓名</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">searchNameAttr</span>(<span class="params"><span class="variable">$query</span>, <span class="variable">$value</span>, <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;like&quot;</span>, <span class="string">&quot;%&quot;</span>.<span class="variable">$value</span>.<span class="string">&quot;%&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 搜索器，限定时间</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">searchCreateTimeAttr</span>(<span class="params"><span class="variable">$query</span>, <span class="variable">$value</span>, <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">whereBetweenTime</span>(<span class="string">&quot;create_time&quot;</span>, <span class="variable">$value</span>[<span class="number">0</span>], <span class="variable">$value</span>[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在控制器端，通过 withSearch()方法实现模型搜索器的调用；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">withSearch</span>([<span class="string">&quot;name&quot;</span>, <span class="string">&quot;create_time&quot;</span>],[</span><br><span class="line">    <span class="string">&quot;name&quot;</span>          =&gt;  <span class="string">&quot;李&quot;</span>,</span><br><span class="line">    <span class="string">&quot;create_time&quot;</span>   =&gt;  [<span class="string">&quot;2023-10-19&quot;</span>, <span class="string">&quot;2023-10-20 23:59:59&quot;</span>]</span><br><span class="line">])-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>withSearch()中第一个数组参数，限定搜索器的字段，第二个则是表达式值；</p>
</li>
<li><p>如果想在搜索器查询的基础上再增加查询条件，直接使用链式查询即可；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">withSearch</span>(...)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;gender&quot;</span>, <span class="string">&quot;女&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>在获取器和修改器都有一个 <strong>$data</strong> 参数，它的作用是什么？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 搜索器，模糊查找姓名</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">searchNameAttr</span>(<span class="params"><span class="variable">$query</span>, <span class="variable">$value</span>, <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//$halt($data);</span></span><br><span class="line">    <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;like&quot;</span>, <span class="string">&quot;%&quot;</span>.<span class="variable">$value</span>.<span class="string">&quot;%&quot;</span>);</span><br><span class="line">    <span class="comment">// 按年龄排序</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$data</span>[<span class="string">&quot;sort&quot;</span>])) &#123;</span><br><span class="line">        <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">order</span>(<span class="variable">$data</span>[<span class="string">&quot;sort&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="自动时间戳"><a href="#自动时间戳" class="headerlink" title="自动时间戳"></a><strong>自动时间戳</strong></h3><ul>
<li><p>如果你想全局开启，在 database.php 中，设置为 true；</p>
</li>
<li><p>此时，写入操作时，会自动对 <strong>create_time</strong> 和 <strong>update_time</strong> 进行写入；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;auto_timestamp&quot;</span>  =&gt; <span class="literal">true</span>,</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果你只想设置某一个模型开启，需要设置特有字段；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$autoWriteTimestamp</span> = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自动时间戳只能在模型下有效，数据库方法不可以使用；</p>
</li>
<li><p>如果创建和修改时间戳不是默认定义的，也可以自定义；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$createTime</span> = <span class="string">&quot;create_at&quot;</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$updateTime</span> = <span class="string">&quot;update_at&quot;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果业务中只需要 create_time 而不需要 update_time，可以关闭它；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$updateTime</span> = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>也可以动态实现不修改 update_time，具体如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">isAutoWriteTimestamp</span>(<span class="literal">false</span>)-&gt;<span class="title function_ invoke__">save</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="软删除和事件"><a href="#软删除和事件" class="headerlink" title="软删除和事件"></a>软删除和事件</h2><h3 id="软删除"><a href="#软删除" class="headerlink" title="软删除"></a><strong>软删除</strong></h3><ul>
<li><p>软删除也称为逻辑删除，只是给数据标记 “已删除” 的状态，不是真实的物理删除；</p>
</li>
<li><p>为何要对数据进行软删除，因为真实的物理删除，删了就没了呀。</p>
</li>
<li><p>在模型端设置软删除的功能，引入 <strong>SoftDelete</strong>，它是 <strong>trait</strong>；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 会自动引入SoftDelete</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">SoftDelete</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开启软删除，创建delete_time字段，并设置默认为 NULL</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">SoftDelete</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$deleteTime</span> = <span class="string">&quot;delete_time&quot;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>delete_time 默认设置的是 null，如果你想更改这个默认值，可以设置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$defaultSoftDelete</span> = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

</li>
<li><p>由于我们之前演示过字段缓存，会导致无法软删除，你可以删除字段缓存，或者重新更新下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think optimize:schema</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除分为两种：destroy() 和 delete()，具体如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 软删除</span></span><br><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">destroy</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 真实删除</span></span><br><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">destroy</span>(<span class="number">1</span>,<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 软删除</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">delete</span>();</span><br><span class="line"><span class="comment">// 真实删除</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">force</span>()-&gt;<span class="title function_ invoke__">delete</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>软删除后，数据库内的数据只是被标记了删除时间，而搜索数据时，会自动屏蔽这些数据；</p>
</li>
<li><p>在开启软删除功能的前提下，使用 <strong>withTrashed()</strong> 方法取消屏蔽软删除的数据；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">withTrashed</span>()-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果只想查询被软删除的数据，使用 onlyTrashed()方法即可；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">onlyTrashed</span>()-&gt;<span class="title function_ invoke__">select</span>()</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果想让某一条被软删除的数据恢复到正常数据，可以使用 restore()方法；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">onlyTrashed</span>()-&gt;<span class="title function_ invoke__">find</span>(<span class="number">23</span>);</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">restore</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果要将软删除后的数据库真实的物理删除，需要先将它恢复，再真实删除；</p>
</li>
</ul>
<h3 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h3><p>模型事件是指在进行模型的查询和写入操作的时候触发的操作行为。</p>
<blockquote>
<p>模型事件只在调用模型的方法生效，使用查询构造器操作是无效的</p>
</blockquote>
<p>模型支持如下事件：</p>
<table>
<thead>
<tr>
<th align="left">事件</th>
<th align="left">描述</th>
<th align="left">事件方法名</th>
</tr>
</thead>
<tbody><tr>
<td align="left">after_read</td>
<td align="left">查询后</td>
<td align="left">onAfterRead</td>
</tr>
<tr>
<td align="left">before_insert</td>
<td align="left">新增前</td>
<td align="left">onBeforeInsert</td>
</tr>
<tr>
<td align="left">after_insert</td>
<td align="left">新增后</td>
<td align="left">onAfterInsert</td>
</tr>
<tr>
<td align="left">before_update</td>
<td align="left">更新前</td>
<td align="left">onBeforeUpdate</td>
</tr>
<tr>
<td align="left">after_update</td>
<td align="left">更新后</td>
<td align="left">onAfterUpdate</td>
</tr>
<tr>
<td align="left">before_write</td>
<td align="left">写入前</td>
<td align="left">onBeforeWrite</td>
</tr>
<tr>
<td align="left">after_write</td>
<td align="left">写入后</td>
<td align="left">onAfterWrite</td>
</tr>
<tr>
<td align="left">before_delete</td>
<td align="left">删除前</td>
<td align="left">onBeforeDelete</td>
</tr>
<tr>
<td align="left">after_delete</td>
<td align="left">删除后</td>
<td align="left">onAfterDelete</td>
</tr>
<tr>
<td align="left">before_restore</td>
<td align="left">恢复前</td>
<td align="left">onBeforeRestore</td>
</tr>
<tr>
<td align="left">after_restore</td>
<td align="left">恢复后</td>
<td align="left">onAfterRestore</td>
</tr>
</tbody></table>
<p>注册的回调方法支持传入一个参数（当前的模型对象实例），但支持依赖注入的方式增加额外参数。</p>
<blockquote>
<p>如果<code>before_write</code>、<code>before_insert</code>、 <code>before_update</code> 、<code>before_delete</code>事件方法中返回<code>false</code>或者抛出<code>think\exception\ModelEventException</code>异常的话，则不会继续执行后续的操作。</p>
</blockquote>
<h4 id="模型事件定义"><a href="#模型事件定义" class="headerlink" title="模型事件定义"></a>模型事件定义</h4><p>最简单的方式是在模型类里面定义静态方法来定义模型的相关事件响应。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">model</span>\<span class="title">Profile</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">onBeforeUpdate</span>(<span class="params"><span class="variable">$user</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    	<span class="keyword">if</span> (<span class="string">&#x27;thinkphp&#x27;</span> == <span class="variable">$user</span>-&gt;name) &#123;</span><br><span class="line">        	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">onAfterDelete</span>(<span class="params"><span class="variable">$user</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">		<span class="title class_">Profile</span>::<span class="title function_ invoke__">destroy</span>(<span class="variable">$user</span>-&gt;id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数是当前的模型对象实例，支持使用依赖注入传入更多的参数。</p>
<h4 id="写入事件"><a href="#写入事件" class="headerlink" title="写入事件"></a>写入事件</h4><p><code>onBeforeWrite</code>和<code>onAfterWrite</code>事件会在<code>新增</code>操作和<code>更新</code>操作都会触发.</p>
<p>具体的触发顺序:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行 onBeforeWrite</span></span><br><span class="line"><span class="comment">// 如果事件没有返回`false`,那么继续执行</span></span><br><span class="line"><span class="comment">// 执行新增或更新操作(onBeforeInsert/onAfterInsert或onBeforeUpdate/onAfterUpdate)</span></span><br><span class="line"><span class="comment">// 新增或更新执行成功</span></span><br><span class="line"><span class="comment">// 执行 onAfterWrite</span></span><br></pre></td></tr></table></figure>

<p>注意:模型的新增或更新是自动判断的.</p>
<h1 id="关联模型"><a href="#关联模型" class="headerlink" title="关联模型"></a>关联模型</h1><h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><h3 id="关联表"><a href="#关联表" class="headerlink" title="关联表"></a><strong>关联表</strong></h3><ul>
<li><p>我们已经有了一张 <strong>tp_user</strong> 表，主键为：<strong>id</strong>；我们需要一个附属表，来进行关联；</p>
</li>
<li><p>附属表：<strong>tp_profile</strong>，建立两个字段：<strong>user_id</strong> 和 <strong>hobby</strong>，外键是 <strong>user_id</strong>；</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../source/imgs/$%7Bfiilname%7D/image-20240716111621480.png" alt="image-20240716111621480"></p>
<h3 id="关联查询"><a href="#关联查询" class="headerlink" title="关联查询"></a><strong>关联查询</strong></h3><ul>
<li><p>关联模型，顾名思义，就是将表与表之间进行关联和对象化，更高效的操作数据；</p>
</li>
<li><p>创建 <strong>User</strong> 模型和 <strong>Profile</strong> 模型，均为空模型；如果已有User，改名UserBak备份起来；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>User</strong> 模型端，需要关联 <strong>Profile</strong>，具体方式如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">profile</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 一对一关联，</span></span><br><span class="line">        <span class="comment">// 参数1：关联的表模型</span></span><br><span class="line">        <span class="comment">// 参数2：默认为 user_id (外键)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasOne</span>(<span class="title class_">Profile</span>::<span class="variable language_">class</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个控制器用于测试输出：Link.php；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 主表</span></span><br><span class="line">    <span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">19</span>);</span><br><span class="line">    <span class="comment">// 访问关联从表</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$user</span>-&gt;profile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="一对一关联查询"><a href="#一对一关联查询" class="headerlink" title="一对一关联查询"></a>一对一关联查询</h2><h3 id="hasOne-模式"><a href="#hasOne-模式" class="headerlink" title="hasOne 模式"></a><strong>hasOne 模式</strong></h3><ul>
<li><p><strong>hasOne</strong> 模式，适合主表关联附表，具体设置方式如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 定义与Profile模型的一对一关系</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">profile</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasOne</span>(<span class="string">&#x27;Profile&#x27;</span>, <span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;id&#x27;</span>);<span class="comment">//返回模型实例</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//关联模型（必须）：关联的模型名或者类名</span></span><br><span class="line"><span class="comment">//外键：默认的外键规则是当前模型名（不含命名空间，下同）+_id ，例如 user_id</span></span><br><span class="line"><span class="comment">//主键：当前模型主键，默认会自动获取也可以指定传入</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>我们了解了表与表关联后，实现的查询方案：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主表</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">19</span>);</span><br><span class="line"><span class="comment">// 访问关联从表</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$user</span>-&gt;profile-&gt;hobby);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 save()方法，可以设置关联修改，通过主表修改附表字段的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">19</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$user</span>-&gt;profile-&gt;<span class="title function_ invoke__">save</span>([<span class="string">&quot;hobby&quot;</span>=&gt;<span class="string">&quot;和蛇妖玩耍！&quot;</span>]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>-&gt;<strong>profile</strong> 属性方式可以修改数据，-&gt;<strong>profile</strong>()方法方式可以新增数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新增附表数据，先找到主表数据</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 然后通过profile()方法实现新增</span></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">profile</span>()-&gt;<span class="title function_ invoke__">save</span>([<span class="string">&quot;hobby&quot;</span>=&gt;<span class="string">&quot;不喜欢吃青椒！&quot;</span>]);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="belongsTo-模式"><a href="#belongsTo-模式" class="headerlink" title="belongsTo 模式"></a><strong>belongsTo 模式</strong></h3><ul>
<li><p>belongsTo 模式，适合附表关联主表，具体设置方式如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意：此时绑定需要Profile模型创建user()方法执行</span></span><br><span class="line"><span class="title function_ invoke__">belongsTo</span>(<span class="string">&quot;关联模型&quot;</span>,[<span class="string">&quot;外键&quot;</span>,<span class="string">&quot;关联主键&quot;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsTo</span>(<span class="title class_">User</span>::<span class="variable language_">class</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询方式，和主附查询方式一致：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 附表</span></span><br><span class="line"><span class="variable">$profile</span> = <span class="title class_">Profile</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 访问关联主表</span></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$profile</span>-&gt;user-&gt;name;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 hasOne()也能模拟 belongsTo() 来进行查询，这样就可以不用在 Profile 模型进行设置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hasWhere</span></span><br><span class="line"><span class="comment">// 注意：参数1的profile是方法名，不是模型名</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">hasWhere</span>(<span class="string">&quot;profile&quot;</span>, [<span class="string">&quot;id&quot;</span>=&gt;<span class="number">2</span>])-&gt;<span class="title function_ invoke__">find</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$user</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 闭包方式</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">hasWhere</span>(<span class="string">&quot;profile&quot;</span>, function (<span class="variable">$query</span>) &#123;</span><br><span class="line">    <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="number">2</span>);</span><br><span class="line">&#125;)-&gt;<span class="title function_ invoke__">find</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$user</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="一对多关联查询"><a href="#一对多关联查询" class="headerlink" title="一对多关联查询"></a>一对多关联查询</h2><h3 id="hasMany-模式"><a href="#hasMany-模式" class="headerlink" title="hasMany 模式"></a><strong>hasMany 模式</strong></h3><ul>
<li><p>hasMany 模式，适合主表关联附表，实现一对多查询，具体设置方式如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 由于是一对多，需要在附表添加多个相同user_id的数据测试</span></span><br><span class="line"><span class="title function_ invoke__">hasMany</span>(<span class="string">&quot;关联模型&quot;</span>,[<span class="string">&quot;外键&quot;</span>,<span class="string">&quot;主键&quot;</span>]);</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasMany</span>(<span class="title class_">Profile</span>::<span class="variable language_">class</span>,<span class="string">&quot;user_id&quot;</span>, <span class="string">&quot;id&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询方案和一对一相同：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主表一对多</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$user</span>-&gt;profile);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用-&gt;profile()方法模式，可以进一步进行数据的筛选；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主表一对多</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 进一步筛选数据，保留实际顺序的下标</span></span><br><span class="line"><span class="variable">$data</span> = <span class="variable">$user</span>-&gt;profile-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="number">10</span>);</span><br><span class="line"><span class="comment">// 进一步筛选数据，下标重新从0开始，需要连缀select()</span></span><br><span class="line"><span class="variable">$data</span> = <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">profile</span>()-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="number">10</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 has()方法，查询关联附表的主表内容，比如大于等于 2 条的主表记录；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数1：profile是方法名</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">has</span>(<span class="string">&quot;profile&quot;</span>, <span class="string">&quot;&gt;=&quot;</span>, <span class="number">2</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$user</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 hasWhere()方法，查询附表中，可见兴趣的主表记录；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询附表profile中visible为1的兴趣关联主表的记录</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">hasWhere</span>(<span class="string">&quot;profile&quot;</span>, [<span class="string">&quot;visible&quot;</span>=&gt;<span class="number">1</span>])-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$user</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 save()和 saveAll()进行关联新增和批量关联新增，方法如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主表数据</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">24</span>);</span><br><span class="line"><span class="comment">// 新增附表关联数据</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">profile</span>()-&gt;<span class="title function_ invoke__">save</span>([<span class="string">&quot;hobby&quot;</span>=&gt;<span class="string">&quot;测试喜欢1&quot;</span>, <span class="string">&quot;visible&quot;</span>=&gt;<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量新增</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">profile</span>()-&gt;<span class="title function_ invoke__">saveAll</span>([</span><br><span class="line">    [<span class="string">&quot;hobby&quot;</span>=&gt;<span class="string">&quot;测试喜欢2&quot;</span>, <span class="string">&quot;visible&quot;</span>=&gt;<span class="number">1</span>],</span><br><span class="line">    [<span class="string">&quot;hobby&quot;</span>=&gt;<span class="string">&quot;测试喜欢3&quot;</span>, <span class="string">&quot;visible&quot;</span>=&gt;<span class="number">1</span>],</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 together()方法，可以删除主表内容时，将附表关联的内容全部删除；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除主数据，并清空关联附表数据</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">with</span>(<span class="string">&quot;profile&quot;</span>)-&gt;<span class="title function_ invoke__">find</span>(<span class="number">29</span>);</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">together</span>([<span class="string">&quot;profile&quot;</span>])-&gt;<span class="title function_ invoke__">delete</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>特别注意：由于外键约束设置问题，默认情况下，关联操作可能会导致1451错误；</p>
</li>
<li><p>解决方案：在 profile 表中 设置外键 删除和修改时 为：CASCADE即可，详细阅读如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//blog.csdn.net/qq_23994787/article/details/86063623</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="模型预载入和统计"><a href="#模型预载入和统计" class="headerlink" title="模型预载入和统计"></a>模型预载入和统计</h2><h3 id="预载入"><a href="#预载入" class="headerlink" title="预载入"></a><strong>预载入</strong></h3><ul>
<li><p>在普通的关联查询下，我们循环数据列表会执行 n+1 次 SQL 查询；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主表三条记录</span></span><br><span class="line"><span class="variable">$list</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">select</span>([<span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>]);</span><br><span class="line"><span class="comment">// 遍历附表</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$list</span> <span class="keyword">as</span> <span class="variable">$user</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">dump</span>(<span class="variable">$user</span>-&gt;profile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面继续采用普通关联查询的构建方式，打开 trace 调试工具，会得到四次查询；</p>
</li>
<li><p>如果采用关联预载入的方式，将会减少到两次，也就是起步一次，循环一次；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$list</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">with</span>([<span class="string">&quot;profile&quot;</span>])-&gt;<span class="title function_ invoke__">select</span>([<span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>]);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$list</span> <span class="keyword">as</span> <span class="variable">$user</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">dump</span>(<span class="variable">$user</span>-&gt;profile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看显示结构</span></span><br><span class="line"><span class="variable">$list</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">with</span>([<span class="string">&quot;profile&quot;</span>])-&gt;<span class="title function_ invoke__">select</span>([<span class="number">1</span>, <span class="number">10</span>, <span class="number">22</span>]);</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$list</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>关联预载入减少了查询次数提高了性能，但是不支持多次调用；</p>
</li>
<li><p>如果你有主表关联了多个附表，都想要进行预载入，可以传入多个模型方法即可；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">with</span>([<span class="string">&quot;profile&quot;</span>, <span class="string">&quot;book&quot;</span>])</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面显示结构中，主表和附表的字段已经非常多了，需要对两个表字段进行筛略：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意1：withField对应另一个是withoutField</span></span><br><span class="line"><span class="comment">// 注意2：关联字段一定要包含外键：user_id，否则空</span></span><br><span class="line"><span class="variable">$list</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">field</span>(<span class="string">&quot;id,age,gender,details&quot;</span>)-&gt;<span class="title function_ invoke__">with</span>([<span class="string">&quot;profile&quot;</span> =&gt; function(<span class="variable">$query</span>) &#123;</span><br><span class="line">    <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">withField</span>([<span class="string">&quot;user_id, hobby&quot;</span>]);</span><br><span class="line">&#125;])-&gt;<span class="title function_ invoke__">select</span>([<span class="number">1</span>, <span class="number">10</span>, <span class="number">22</span>]);</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$list</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者简单些</span></span><br><span class="line"><span class="variable">$list</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">with</span>(<span class="string">&quot;profile&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line"><span class="comment">// 直接字段，隐藏主表，加上profile隐藏附表，除了hidden，还有对应的visible方法</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$list</span>-&gt;<span class="title function_ invoke__">hidden</span>([<span class="string">&quot;status&quot;</span>, <span class="string">&quot;profile.visible&quot;</span>]));</span><br></pre></td></tr></table></figure>
</li>
<li><p>还有一些 预载入缓存、延迟预载入，可以参考手册；</p>
</li>
</ul>
<h3 id="关联统计"><a href="#关联统计" class="headerlink" title="关联统计"></a><strong>关联统计</strong></h3><ul>
<li><p>使用 withCount()方法，可以统计主表关联附表的个数，输出用 profile_count；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 统计这三条数据关联的附表数据的个数</span></span><br><span class="line"><span class="variable">$list</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">withCount</span>([<span class="string">&quot;profile&quot;</span>])-&gt;<span class="title function_ invoke__">select</span>([<span class="number">1</span>, <span class="number">10</span>, <span class="number">22</span>]);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$list</span> <span class="keyword">as</span> <span class="variable">$user</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$user</span>-&gt;profile_count.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>关联统计的输出采用“关联方法名” <strong>_count</strong>，这种结构输出；</p>
</li>
<li><p>不单单支持 Count，还有如下统计方法，均可支持；</p>
</li>
<li><p>**withMax()<strong>、</strong>withMin()<strong>、</strong>withSum()<strong>、</strong>withAvg()**等；</p>
</li>
<li><p>除了 withCount()不需要指定字段，其它均需要指定统计字段；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 统计附表关联字段的累加和</span></span><br><span class="line"><span class="variable">$list</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">withSum</span>([<span class="string">&quot;profile&quot;</span>], <span class="string">&quot;visible&quot;</span>)-&gt;<span class="title function_ invoke__">select</span>([<span class="number">1</span>, <span class="number">10</span>, <span class="number">22</span>]);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$list</span> <span class="keyword">as</span> <span class="variable">$user</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$user</span>-&gt;profile_sum.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>对于输出的属性，可以自定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">withSum</span>([<span class="string">&quot;profile&quot;</span>=&gt;<span class="string">&quot;p_s&quot;</span>], <span class="string">&quot;visible&quot;</span>)</span><br><span class="line"><span class="variable">$user</span>-&gt;p_s</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="多对多关联查询"><a href="#多对多关联查询" class="headerlink" title="多对多关联查询"></a>多对多关联查询</h2><h3 id="建立三张表"><a href="#建立三张表" class="headerlink" title="建立三张表"></a><strong>建立三张表</strong></h3><ul>
<li><p>复习一下一对一，一个用户对应一个用户档案资料，是一对一关联；</p>
</li>
<li><p>复习一下一对多，一篇文章对应多个评论，是一对多关联；</p>
</li>
<li><p>多对多怎么理解，分解来看，一个用户对应多个角色，而一个角色对应多个用户；</p>
</li>
<li><p>那么这种对应关系，就是多对多关系，最经典的应用就是权限控制；</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../source/imgs/$%7Bfiilname%7D/image-20240716154343740.png" alt="image-20240716154343740"></p>
<ul>
<li><p>tp_user：用户表；tp_role：角色表；tp_access：中间表；</p>
</li>
<li><p>access 表包含了 user 和 role 表的关联 id，多对多模式；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">role</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// belongsToMany(&quot;关联模型&quot;,&quot;中间表&quot;,[&quot;外键&quot;,&quot;关联键&quot;]);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsToMany</span>(<span class="title class_">Role</span>::<span class="variable language_">class</span>, <span class="title class_">Access</span>::<span class="variable language_">class</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里继承的是Pivot，它本身也继承了Model</span></span><br><span class="line"><span class="comment">// Pivoit是中间表基类，多对多专用模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Access</span> <span class="keyword">extends</span> <span class="title">Pivot</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="权限控制"><a href="#权限控制" class="headerlink" title="权限控制"></a><strong>权限控制</strong></h3><ul>
<li><p>在控制器段，我们查询一下id为1的用户，并关联查询它的权限：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取一个用户，张三</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 获取这个用户所有角色</span></span><br><span class="line"><span class="variable">$role</span> = <span class="variable">$user</span>-&gt;role;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">json</span>(<span class="variable">$role</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>当我们要给一个用户创建一个角色时，用到多对多关联新增；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果这个角色不存在，则会给角色表增加一条信息</span></span><br><span class="line"><span class="comment">// 并且，会在中间表关联角色和用户</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">role</span>()-&gt;<span class="title function_ invoke__">save</span>([<span class="string">&quot;type&quot;</span>=&gt;<span class="string">&quot;测试管理专员&quot;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也支持批量</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">role</span>()-&gt;<span class="title function_ invoke__">saveAll</span>([[...],[...]]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>一般来说，上面的这种新增方式，用于初始化角色比较合适；</p>
</li>
<li><p>但是，很多情况下，角色权限是初始化好的，只需要添加中间表，而不是角色表；</p>
</li>
<li><p>那么，我们真正需要就是通过用户表新增到中间表关联即可；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给张三添加一个已经存在的角色，直接传角色ID即可</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">role</span>()-&gt;<span class="title function_ invoke__">save</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">role</span>()-&gt;<span class="title function_ invoke__">save</span>(<span class="title class_">Role</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>));</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">role</span>()-&gt;<span class="title function_ invoke__">saveAll</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 或，如果有其它字段，可以通过中括号添加</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">role</span>()-&gt;<span class="title function_ invoke__">attach</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">role</span>()-&gt;<span class="title function_ invoke__">attach</span>(<span class="number">2</span>, [<span class="string">&quot;details&quot;</span>=&gt;<span class="string">&quot;测试详情&quot;</span>]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>除了新增，还有直接删除中间表数据的方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 取消掉张三的所有，1，2，6，这里的值是角色的ID，不是中间表ID</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">role</span>()-&gt;<span class="title function_ invoke__">detach</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">role</span>()-&gt;<span class="title function_ invoke__">detach</span>([<span class="number">2</span>, <span class="number">6</span>]);</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h1><h2 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h2><h3 id="路由入门"><a href="#路由入门" class="headerlink" title="路由入门"></a><strong>路由入门</strong></h3><ul>
<li><p>路由的作用就是让 URL 地址更加的规范和优雅，或者说更加简洁；</p>
</li>
<li><p>设置路由对 URL 的检测、验证等一系列操作提供了极大的便利性；</p>
</li>
<li><p>路由是默认开启的，如果想要关闭路由，在 <strong>config&#x2F;app.php</strong> 配置；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 是否启用路由</span></span><br><span class="line"><span class="string">&quot;with_route&quot;</span>       =&gt; <span class="literal">true</span>,</span><br></pre></td></tr></table></figure>
</li>
<li><p>路由的配置文件在 <strong>config&#x2F;route.php</strong> 中，定义文件在 <strong>route&#x2F;app.php</strong>；</p>
</li>
<li><p>我们还回到最初的 Index 控制器，创建一个 details 带 参数的方法；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">details</span>(<span class="params"><span class="variable">$id</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;details ID：&quot;</span>.<span class="variable">$id</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//www.tp.com:8000/index/details/id/5</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>此时，我们在根目录 route 下的 app.php 里配置路由：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数1：url/参数</span></span><br><span class="line"><span class="comment">// 参数2：控制器/方法</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details/:id&quot;</span>, <span class="string">&quot;Index/details&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问地址</span></span><br><span class="line">http:<span class="comment">//www.tp.com:8000/details/5</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>rule()方法是默认请求是 any，即任何请求类型均可，第三参数可以限制：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details/:id&quot;</span>, <span class="string">&quot;Index/xxx&quot;</span>, <span class="string">&quot;GET&quot;</span>);</span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details/:id&quot;</span>, <span class="string">&quot;Index/xxx&quot;</span>, <span class="string">&quot;POST&quot;</span>);</span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details/:id&quot;</span>, <span class="string">&quot;Index/xxx&quot;</span>, <span class="string">&quot;GET|POST&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>所有的请求方式均有快捷方式，比如 <strong>::get()</strong> 、**::post()** 等，具体查看手册：路由 -&gt; 路由定义；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 快捷方式，无须第三参数了</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(...)</span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">post</span>(...)</span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">delete</span>(...)</span><br></pre></td></tr></table></figure>
</li>
<li><p>在路由的规则表达式中，有多种地址的配置规则：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 静态路由</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;Index/test&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带一个参数</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details/:id&quot;</span>, <span class="string">&quot;Index/details&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带两个参数</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details/:id/:uid&quot;</span>, <span class="string">&quot;Index/details&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带可选参数，一般在后面</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details/:id/[:uid]&quot;</span>, <span class="string">&quot;Index/details&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全动态地址，不限定details，url可以是：abc/5/6，后面details也可以动态</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;:details/:id/:uid&quot;</span>, <span class="string">&quot;Index/details&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正则规则，完全匹配</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details/:id/:uid$&quot;</span>, <span class="string">&quot;Index/details&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="强制路由"><a href="#强制路由" class="headerlink" title="强制路由"></a><strong>强制路由</strong></h3><ul>
<li><p>目前来说，路由访问模式和URL访问模式都可以使用，但我们强制路由访问；</p>
</li>
<li><p>开始强制路由，需要在 route.php 里面进行配置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 是否强制使用路由</span></span><br><span class="line"><span class="string">&quot;url_route_must&quot;</span>        =&gt; <span class="literal">true</span>,</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首页也必须设置路由</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;Index/index&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="完全匹配"><a href="#完全匹配" class="headerlink" title="完全匹配"></a>完全匹配</h3><p>规则匹配检测的时候默认只是对URL从头开始匹配，只要URL地址开头包含了定义的路由规则就会匹配成功，如果希望URL进行完全匹配，可以在路由表达式最后使用<code>$</code>符号，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;new/:cate$&#x27;</span>, <span class="string">&#x27;News/category&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>这样定义后</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//serverName/index.php/new/info</span></span><br></pre></td></tr></table></figure>

<p>会匹配成功,而</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//serverName/index.php/new/info/2</span></span><br></pre></td></tr></table></figure>

<p>则不会匹配成功。</p>
<p>如果是采用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;new/:cate&#x27;</span>, <span class="string">&#x27;News/category&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>方式定义的话，则两种方式的URL访问都可以匹配成功。</p>
<p>如果需要全局进行URL完全匹配，可以在路由配置文件中设置</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开启路由完全匹配</span></span><br><span class="line"><span class="string">&#x27;route_complete_match&#x27;</span>   =&gt; <span class="literal">true</span>,</span><br></pre></td></tr></table></figure>

<p>开启全局完全匹配后，如果需要对某个路由关闭完全匹配，可以使用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;new/:cate&#x27;</span>, <span class="string">&#x27;News/category&#x27;</span>)-&gt;<span class="title function_ invoke__">completeMatch</span>(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<h2 id="路由闭包和变量规则"><a href="#路由闭包和变量规则" class="headerlink" title="路由闭包和变量规则"></a>路由闭包和变量规则</h2><h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a><strong>闭包</strong></h3><ul>
<li><p>闭包支持我们可以通过 URL 直接执行，而不需要通过控制器和方法；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 闭包</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&quot;think&quot;</span>, function () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello, ThinkPHP8!&quot;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>闭包支持也可以传递参数和动态规则：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 带参数闭包，如果不带:version，那么地址：php?version=8</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&quot;php/:version&quot;</span>, function (<span class="variable">$version</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;PHP&quot;</span>.<span class="variable">$version</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="变量规则"><a href="#变量规则" class="headerlink" title="变量规则"></a><strong>变量规则</strong></h3><ul>
<li><p>系统默认的路由变量规则为\w+，即字母、数字、中文和下划线；</p>
</li>
<li><p>如果你想更改默认的匹配规则，可以修改 <strong>config&#x2F;route.php</strong> 配置；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认的路由变量规则</span></span><br><span class="line"><span class="string">&quot;default_route_pattern&quot;</span> =&gt; <span class="string">&quot;[\w\.]+&quot;</span>,</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果我们需要对于具体的变量进行单独的规则设置，则需要通过 <strong>pattern()</strong> 方法；</p>
</li>
<li><p>将 details 方法里的 id 传值，严格限制必须只能是数字\d+；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正则规则 \d+ 限定id为数字</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details/:id&quot;</span>, <span class="string">&quot;Index/details&quot;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">pattern</span>([<span class="string">&quot;id&quot;</span>=&gt;<span class="string">&quot;\d+&quot;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多个参数</span></span><br><span class="line">-&gt;<span class="title function_ invoke__">pattern</span>([</span><br><span class="line">    <span class="string">&quot;id&quot;</span>  =&gt; <span class="string">&quot;\d+&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span> =&gt; <span class="string">&quot;\d+&quot;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果让指定的参数统一限定为数字，比如id和uid，也就是全局设置，在app.php顶部设置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">pattern</span>([</span><br><span class="line">    <span class="string">&quot;id&quot;</span>  =&gt; <span class="string">&quot;\d+&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span> =&gt; <span class="string">&quot;\d+&quot;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>不喜欢斜杠怎么办？能换成减号吗？可以的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 支持替换斜杠</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details-:id&quot;</span>, <span class="string">&quot;Index/details&quot;</span>);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 支持组合变量&lt;id&gt;方式</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details-&lt;id&gt;&quot;</span>, <span class="string">&quot;Index/details&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="路由参数-域名-MISS"><a href="#路由参数-域名-MISS" class="headerlink" title="路由参数.域名.MISS"></a>路由参数.域名.MISS</h2><h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a><strong>参数</strong></h3><ul>
<li><p>设置路由的时候，可以设置相关方法进行，从而实施匹配检测和行为执行；</p>
</li>
<li><p>ext 方法作用是检测 URL 后缀，比如：我们强制所有 URL 后缀为.html；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;Index/test&quot;</span>)-&gt;<span class="title function_ invoke__">ext</span>(<span class="string">&quot;html&quot;</span>);</span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;Index/test&quot;</span>)-&gt;<span class="title function_ invoke__">ext</span>(<span class="string">&quot;html|shtml&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>https 方法作用是检测是否为 https 请求，结合 ext 强制 html 如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;Index/test&quot;</span>)-&gt;<span class="title function_ invoke__">ext</span>(<span class="string">&quot;html&quot;</span>)-&gt;<span class="title function_ invoke__">https</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果想让全局统一配置 URL 后缀的话，可以在 config&#x2F;route.php 中设置；</p>
</li>
<li><p>具体值可以是单个或多个后缀，也可以是空字符串(任意后缀)，false 禁止后缀；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// URL伪静态后缀</span></span><br><span class="line"><span class="string">&quot;url_html_suffix&quot;</span>       =&gt; <span class="string">&quot;html&quot;</span>,</span><br></pre></td></tr></table></figure>
</li>
<li><p>denyExt 方法作用是禁止某些后缀的使用，使用后直接报错；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可以将url_html_suffix 设置为空测试</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;Index/test&quot;</span>)-&gt;<span class="title function_ invoke__">denyExt</span>(<span class="string">&quot;jpg|gif|png&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>domain 方法作用是检测当前的域名是否匹配，完整域名和子域名均可；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;Index/test&quot;</span>)-&gt;<span class="title function_ invoke__">domain</span>(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;Index/test&quot;</span>)-&gt;<span class="title function_ invoke__">domain</span>(<span class="string">&quot;new.tp.com&quot;</span>);</span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;Index/test&quot;</span>)-&gt;<span class="title function_ invoke__">domain</span>(<span class="string">&quot;new&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>还有ajax&#x2F;pjax&#x2F;json检测、filter 额外参数检测、append追加额外参数、option统一管理检测，可参考手册；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;Index/test&quot;</span>)-&gt;<span class="title function_ invoke__">option</span>([</span><br><span class="line">    <span class="string">&quot;ext&quot;</span>       =&gt;  <span class="string">&quot;html&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https&quot;</span>     =&gt;  <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;domain&quot;</span>    =&gt;  <span class="string">&quot;www.tp.com&quot;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="域名"><a href="#域名" class="headerlink" title="域名"></a><strong>域名</strong></h3><ul>
<li><p>如果想限定的某个域名下生效的路由，比如 <strong>news.tp.com</strong> 可以通过域名闭包方式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">domain</span>(<span class="string">&quot;news.tp.com&quot;</span>, function () &#123;</span><br><span class="line">	<span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details/:id&quot;</span>, <span class="string">&quot;Index/details&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">domain</span>(<span class="string">&quot;news&quot;</span>, function () &#123;</span><br><span class="line">	<span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details/:id&quot;</span>, <span class="string">&quot;Index/details&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>路由域名也支持：ext、pattern、append 等路由参数方法的操作；</p>
</li>
</ul>
<h3 id="MISS"><a href="#MISS" class="headerlink" title="MISS"></a><strong>MISS</strong></h3><ul>
<li><p>全局 MISS,类似开启强制路由功能，匹配不到相应规则时自动跳转到 MISS；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">miss</span>(<span class="string">&quot;Error/miss&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 闭包模式</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">miss</span>(function () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;MISS 404&quot;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="路由分组-URL生成"><a href="#路由分组-URL生成" class="headerlink" title="路由分组.URL生成"></a>路由分组.URL生成</h2><h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a><strong>分组</strong></h3><ul>
<li><p>路由分组，即将相同前缀的路由合并分组，这样可以简化路由定义，提高匹配效率；</p>
</li>
<li><p>使用 group()方法，来进行分组路由的注册；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">group</span>(<span class="string">&quot;index&quot;</span>, function () &#123;</span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;:id&quot;</span>, <span class="string">&quot;Index/details&quot;</span>);</span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;:name&quot;</span>, <span class="string">&quot;Index/hello&quot;</span>);</span><br><span class="line">&#125;)-&gt;<span class="title function_ invoke__">ext</span>(<span class="string">&quot;html&quot;</span>)-&gt;<span class="title function_ invoke__">pattern</span>([<span class="string">&quot;id&quot;</span>=&gt;<span class="string">&quot;\d+&quot;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// URL1: http://www.tp.com:8000/index/5.html</span></span><br><span class="line"><span class="comment">// URL2: http://www.tp.com:8000/index/world.html</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>也可以省去第一参数，让分组路由更灵活一些；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">group</span>(function() &#123;</span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;Index/test&quot;</span>);</span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;h/:name&quot;</span>, <span class="string">&quot;Index/hello&quot;</span>);</span><br><span class="line">&#125;)-&gt;<span class="title function_ invoke__">ext</span>(<span class="string">&quot;html&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// URL1: http://www.tp.com:8000/test.html</span></span><br><span class="line"><span class="comment">// URL2: http://www.tp.com:8000/h/world.html</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 prefix()方法，可以省略掉分组地址里的控制器；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">group</span>(<span class="string">&quot;index&quot;</span>, function () &#123;</span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;:name&quot;</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">&#125;)-&gt;<span class="title function_ invoke__">prefix</span>(<span class="string">&quot;Index/&quot;</span>)-&gt;<span class="title function_ invoke__">ext</span>(<span class="string">&quot;html&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// URL1: http://www.tp.com:8000/index/test.html</span></span><br><span class="line"><span class="comment">// URL2: http://www.tp.com:8000/index/world.html</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="URL生成"><a href="#URL生成" class="headerlink" title="URL生成"></a><strong>URL生成</strong></h3><ul>
<li><p>使用 <strong>url()</strong> 助手函数来生成定义好的路由地址，放在在控制器使用；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 静态不带参数的</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;Index/test&quot;</span>)-&gt;<span class="title function_ invoke__">ext</span>(<span class="string">&quot;html&quot;</span>);</span><br><span class="line"><span class="comment">// 控制器段获取url：/test.html</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">url</span>(<span class="string">&quot;Index/test&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态带参数的</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details/:id&quot;</span>, <span class="string">&quot;Index/details&quot;</span>)-&gt;<span class="title function_ invoke__">ext</span>(<span class="string">&quot;html&quot;</span>);</span><br><span class="line"><span class="comment">// 控制器段获取url：/details/5.html</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">url</span>(<span class="string">&quot;Index/details&quot;</span>, [<span class="string">&quot;id&quot;</span>=&gt;<span class="number">5</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// url参数一和路由的rule的参数二是一致的，可以通过name方法复刻；</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&quot;details/:id&quot;</span>, <span class="string">&quot;Index/details&quot;</span>)-&gt;<span class="title function_ invoke__">name</span>(<span class="string">&quot;de&quot;</span>)-&gt;<span class="title function_ invoke__">ext</span>(<span class="string">&quot;html&quot;</span>);</span><br><span class="line"><span class="comment">// 控制器段获取url：/details/5.html</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">url</span>(<span class="string">&quot;de&quot;</span>, [<span class="string">&quot;id&quot;</span>=&gt;<span class="number">5</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 完整带域名的地址：http://www.tp.com:8000/details/5.html</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">url</span>(<span class="string">&quot;de&quot;</span>, [<span class="string">&quot;id&quot;</span>=&gt;<span class="number">5</span>])-&gt;<span class="title function_ invoke__">domain</span>(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">url</span>(<span class="string">&quot;de&quot;</span>, [<span class="string">&quot;id&quot;</span>=&gt;<span class="number">5</span>])-&gt;<span class="title function_ invoke__">domain</span>(<span class="string">&quot;www.tp.com&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在手册 -&gt; 路由 -&gt; URL 生成 有 <strong>Route::buildUrl()</strong> 源方法，只不过助手函数，更方便；</p>
</li>
</ul>
<h2 id="资源路由"><a href="#资源路由" class="headerlink" title="资源路由"></a>资源路由</h2><h3 id="创建资源"><a href="#创建资源" class="headerlink" title="创建资源"></a><strong>创建资源</strong></h3><ul>
<li><p>资源路由，采用固定的常用方法来实现简化 URL 的功能；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">resource</span>(<span class="string">&quot;blog&quot;</span>, <span class="string">&quot;Blog&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>系统提供了一个命令，方便开发者快速生成一个资源控制器；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think make:controller Blog</span><br></pre></td></tr></table></figure>
</li>
<li><p>以上的两部操作，创建了一个控制器Blog类，并生成了增删改查操作的方法，而且还实现了全部路由：</p>
<table>
<thead>
<tr>
<th align="center">标识</th>
<th align="center">请求类型</th>
<th align="center">路由规则</th>
<th align="center">操作方法</th>
</tr>
</thead>
<tbody><tr>
<td align="center">index</td>
<td align="center">GET</td>
<td align="center">blog</td>
<td align="center">index</td>
</tr>
<tr>
<td align="center">create</td>
<td align="center">GET</td>
<td align="center">blog&#x2F;create</td>
<td align="center">create</td>
</tr>
<tr>
<td align="center">save</td>
<td align="center">POST</td>
<td align="center">blog</td>
<td align="center">save</td>
</tr>
<tr>
<td align="center">read</td>
<td align="center">GET</td>
<td align="center">blog&#x2F;:id</td>
<td align="center">read</td>
</tr>
<tr>
<td align="center">edit</td>
<td align="center">GET</td>
<td align="center">blog&#x2F;:id&#x2F;edit</td>
<td align="center">edit</td>
</tr>
<tr>
<td align="center">update</td>
<td align="center">PUT</td>
<td align="center">blog&#x2F;:id</td>
<td align="center">update</td>
</tr>
<tr>
<td align="center">delete</td>
<td align="center">DELETE</td>
<td align="center">blog&#x2F;:id</td>
<td align="center">delete</td>
</tr>
</tbody></table>
</li>
</ul>
<h3 id="地址URL"><a href="#地址URL" class="headerlink" title="地址URL"></a><strong>地址URL</strong></h3><ul>
<li><p>资源路由注册好后，所有地址都是全自动生成，具体如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//www.tp.com:8000/blog				//GET 访问的是index方法，用于显示数据</span></span><br><span class="line">http:<span class="comment">//www.tp.com:8000/blog/create		//GET 访问的是create方法，新增数据的表单页面</span></span><br><span class="line">http:<span class="comment">//www.tp.com:8000/blog/5			//GET 访问的是read方法，读取指定id的一条数据</span></span><br><span class="line">http:<span class="comment">//www.tp.com:8000/blog/5/edit		//GET 访问的是edit方法，读取指定id数据并显示修改表单</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//www.tp.com:8000/blog				//POST 访问的是save方法，用于接收表单提交的新增数据</span></span><br><span class="line">http:<span class="comment">//www.tp.com:8000/blog/5			//PUT  访问的是update方法，用于接收表单提交的修改数据</span></span><br><span class="line">http:<span class="comment">//www.tp.com:8000/blog/5			//DELETE 访问的是delete方法，用于接收数据删除信息</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>默认的参数采用 id 名称，如果你想别的，比如：blog_id；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//相应的 delete($blog_id)</span></span><br><span class="line">...-&gt;<span class="title function_ invoke__">vars</span>([<span class="string">&quot;blog&quot;</span>=&gt;<span class="string">&quot;blog_id&quot;</span>]); </span><br></pre></td></tr></table></figure>
</li>
<li><p>也可以通过 <strong>only()</strong> 方法限定系统提供的资源方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只允许指定的这些操作</span></span><br><span class="line">...-&gt;<span class="title function_ invoke__">only</span>([<span class="string">&quot;index&quot;</span>,<span class="string">&quot;save&quot;</span>,<span class="string">&quot;create&quot;</span>]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>还可以通过 <strong>except()</strong> 方法排除系统提供的资源方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// only相反操作</span></span><br><span class="line">...-&gt;<span class="title function_ invoke__">except</span>([<span class="string">&quot;read&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;update&quot;</span>])</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <strong>rest()</strong> 方法，更改系统给予的默认方法，1.请求方式；2.地址；3.操作；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rest</span>(<span class="string">&quot;create&quot;</span>, [<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;/add&quot;</span>, <span class="string">&quot;add&quot;</span>]);</span><br><span class="line"><span class="comment">// 批量</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rest</span>([</span><br><span class="line">    <span class="string">&quot;save&quot;</span> =&gt; [<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;store&quot;</span>],</span><br><span class="line">    <span class="string">&quot;update&quot;</span> =&gt; [<span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;/:id&quot;</span>, <span class="string">&quot;save&quot;</span>],</span><br><span class="line">    <span class="string">&quot;delete&quot;</span> =&gt; [<span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;/:id&quot;</span>, <span class="string">&quot;destory&quot;</span>],</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>支持嵌套资源路由，类似于一对多关联的感觉，实战中用到再操作，详情查看手册：</p>
</li>
</ul>
<h1 id="视图-变量-渲染"><a href="#视图-变量-渲染" class="headerlink" title="视图.变量,渲染"></a>视图.变量,渲染</h1><h2 id="视图操作"><a href="#视图操作" class="headerlink" title="视图操作"></a><strong>视图操作</strong></h2><ul>
<li><p>首先，为了方便后续课程学习，先把路由给关闭了；并创建一个用于测试视图的控制器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 是否启用路由</span></span><br><span class="line"><span class="string">&quot;with_route&quot;</span>       =&gt; <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 视图控制器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewPage</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;view&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>由于我们不用模板引擎，直接使用php原生，就需要使用 <strong>engine()</strong> 方法，载入 test 模板；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 载入原生php模板</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">View</span>::<span class="title function_ invoke__">engine</span>(<span class="string">&quot;php&quot;</span>)-&gt;<span class="title function_ invoke__">fetch</span>(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模板地址为：view/view_page/test.html</span></span><br><span class="line"><span class="comment">// 或修改配置文件，将Think改为php就可以使用助手函数</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">view</span>(<span class="string">&quot;test&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果希望模板后缀为 <strong>.php</strong>，方便 php + html5 混编，在 <strong>config&#x2F;view</strong> 设置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模板后缀</span></span><br><span class="line"><span class="string">&quot;view_suffix&quot;</span>   =&gt; <span class="string">&quot;php&quot;</span>,</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 fetch() 方法的第二参数，通过数组方式给模板传递变量：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title class_">View</span>::<span class="title function_ invoke__">engine</span>(<span class="string">&quot;php&quot;</span>)-&gt;<span class="title function_ invoke__">fetch</span>(<span class="string">&quot;test&quot;</span>, [</span><br><span class="line">    <span class="string">&quot;name&quot;</span>  =&gt;  <span class="string">&quot;ThinkPHP8&quot;</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">view</span>(<span class="string">&quot;test&quot;</span>，[</span><br><span class="line">    <span class="string">&quot;name&quot;</span>  =&gt;  <span class="string">&quot;ThinkPHP8&quot;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="表单提交"><a href="#表单提交" class="headerlink" title="表单提交"></a><strong>表单提交</strong></h2><ul>
<li><p>先载入一个表单页面：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title class_">View</span>::<span class="title function_ invoke__">engine</span>(<span class="string">&quot;php&quot;</span>)-&gt;<span class="title function_ invoke__">fetch</span>(<span class="string">&quot;input&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个表单：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/view_page/save&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span>	</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>接受数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">post</span>(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="请求对象-变量-信息"><a href="#请求对象-变量-信息" class="headerlink" title="请求对象.变量.信息"></a>请求对象.变量.信息</h1><h2 id="请求对象"><a href="#请求对象" class="headerlink" title="请求对象"></a><strong>请求对象</strong></h2><ul>
<li><p>上一节课中表单提交时，我们接受数据使用了 <strong>$this-&gt;request-&gt;post()</strong> 方法，这哪里来的？</p>
</li>
<li><p>因为我们的控制器继承了 <strong>BaseController</strong> 追踪进去，可以看到 <strong>$request</strong> 成员字段；</p>
</li>
<li><p>关于这个知识点的源知识点，可以参考：手册 -&gt; 架构 -&gt; 容器和依赖注入，TP6讲过，8不讲了；</p>
</li>
<li><p>在没有继承 BaseController 时，我们需要自己手动注入请求：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Request</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rely</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$request</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 依赖注入</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;request = <span class="variable">$request</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">halt</span>(<span class="variable">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">get</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上面的请求方式比较原始，过于麻烦，不推荐了</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第二种方式：<strong>门面Facade</strong>，它相关的知识点在手册 -&gt; 架构 -&gt; 门面：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">facade</span>\<span class="title">Request</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rely</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">halt</span>(<span class="title class_">Request</span>::<span class="title function_ invoke__">get</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三种方式：继承 <strong>BaseController</strong>，其实就是第一种，只不过被封装到基类中去了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">BaseController</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rely</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">halt</span>(<span class="variable">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">get</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第四种方式：终极方法 <strong>request()</strong>  助手函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">halt</span>(<span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">get</span>());</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="请求信息"><a href="#请求信息" class="headerlink" title="请求信息"></a><strong>请求信息</strong></h2><ul>
<li><p>在手册 请求 -&gt; 请求信息 里有全部的请求方法模块，这里列举几个意思一下：</p>
<table>
<thead>
<tr>
<th align="center">方法</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">host</td>
<td align="left">当前访问域名或者IP</td>
</tr>
<tr>
<td align="center">port</td>
<td align="left">当前访问的端口</td>
</tr>
<tr>
<td align="center">url</td>
<td align="left">当前完整URL</td>
</tr>
<tr>
<td align="center">root</td>
<td align="left">URL访问根地址</td>
</tr>
<tr>
<td align="center">method</td>
<td align="left">当前请求类型</td>
</tr>
</tbody></table>
</li>
<li><p>我们三种方法演示一遍，最终选一种你喜欢的即可：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当前url</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">url</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title class_">Request</span>::<span class="title function_ invoke__">url</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">url</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求方法</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">method</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更多的对照手册自行测试即可</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="请求变量"><a href="#请求变量" class="headerlink" title="请求变量"></a><strong>请求变量</strong></h2><ul>
<li><p>Request 对象支持全局变量的检测、获取和安全过滤，支持$_GET、$_POST…等；</p>
</li>
<li><p>使用 <strong>has()</strong> 方法，可以检测全局变量是否已经设置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否有GET模式下id的值</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">has</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;get&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>更多方法，参看手册 请求 -&gt; 输入变量， 这里意思几个：</p>
<table>
<thead>
<tr>
<th align="center">方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">param</td>
<td>获取当前请求变量</td>
</tr>
<tr>
<td align="center">get</td>
<td>获取 $_GET 变量</td>
</tr>
<tr>
<td align="center">post</td>
<td>获取 $_POST 变量</td>
</tr>
<tr>
<td align="center">put</td>
<td>获取 PUT 变量</td>
</tr>
<tr>
<td align="center">delete</td>
<td>获取 DELETE 变量</td>
</tr>
<tr>
<td align="center">session</td>
<td>获取 SESSION 变量</td>
</tr>
</tbody></table>
</li>
<li><p><strong>param()</strong> 方法是框架推荐的方法，可以自动识别诸如 get、post等数据信息；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// url: http://www.tp.com:8000/rely/index?id=5</span></span><br><span class="line"><span class="comment">// 可以获取 get 模式 id 的值</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">param</span>(<span class="string">&quot;id&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&quot;id&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// url: http://www.tp.com:8000/rely/index/id/5</span></span><br><span class="line"><span class="comment">// 此时，只能是param获取</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">param</span>(<span class="string">&quot;id&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认值</span></span><br><span class="line"><span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">param</span>(<span class="string">&quot;name&quot;</span>)			<span class="comment">// null，实际上页面也转行成空，判断null也成立</span></span><br><span class="line"><span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">param</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>)		<span class="comment">// 空字符串</span></span><br><span class="line"><span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">param</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;无名氏&quot;</span>);	  <span class="comment">// 无名氏</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>可在 <strong>app\Request.php</strong> 配置过滤器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//www.tp.com:8000/rely/index?name=我&lt;b&gt;你&lt;/b&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将特殊字符转换HTML实体</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$filter</span> = [<span class="string">&quot;htmlspecialchars&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果不想要全局过滤器，可以直接局部</span></span><br><span class="line"><span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">param</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;htmlspecialchars&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置了全局过滤器，但某个不想用</span></span><br><span class="line"><span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">param</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用变量修饰符，可以将参数强制转换成指定的类型；</span></span><br><span class="line"><span class="comment">// /s(字符串)、/d(整型)、/b(布尔)、/a(数组)、/f(浮点)；</span></span><br><span class="line"><span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">param</span>(<span class="string">&quot;id/d&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>only()<strong>、</strong>except()</strong> 设置允许和排查可接受的变量：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 允许id和name变量</span></span><br><span class="line"><span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">only</span>([<span class="string">&quot;id&quot;</span>,<span class="string">&quot;name&quot;</span>]);</span><br><span class="line"><span class="comment">// 默认值设置</span></span><br><span class="line"><span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">only</span>([<span class="string">&quot;id&quot;</span>=&gt;<span class="number">1</span>,<span class="string">&quot;name&quot;</span>=&gt;<span class="string">&quot;默认值&quot;</span>]);</span><br><span class="line"><span class="comment">// 参数二可设置GET还是POST等</span></span><br><span class="line"><span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">only</span>([<span class="string">&quot;id&quot;</span>,<span class="string">&quot;name&quot;</span>], <span class="string">&quot;GET&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>以上所有，都封装到助手函数 <strong>input()</strong> 里了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">input</span>(<span class="string">&quot;?get.id&quot;</span>); 		<span class="comment">//判断 get 下的 id 是否存在</span></span><br><span class="line"><span class="title function_ invoke__">input</span>(<span class="string">&quot;?post.name&quot;</span>); 	<span class="comment">//判断 post 下的 name 是否存在</span></span><br><span class="line"><span class="title function_ invoke__">input</span>(<span class="string">&quot;param.name&quot;</span>); 	<span class="comment">//获取 param 下的 name 值</span></span><br><span class="line"><span class="title function_ invoke__">input</span>(<span class="string">&quot;param.name&quot;</span>, <span class="string">&quot;默认值&quot;</span>); 	<span class="comment">//默认值</span></span><br><span class="line"><span class="title function_ invoke__">input</span>(<span class="string">&quot;param.name&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;htmlspecialchars&quot;</span>); 	<span class="comment">//过滤器</span></span><br><span class="line"><span class="title function_ invoke__">input</span>(<span class="string">&quot;param.id/d&quot;</span>); 	<span class="comment">//设置强制转换</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="请求类型-输出-重定向"><a href="#请求类型-输出-重定向" class="headerlink" title="请求类型.输出.重定向"></a>请求类型.输出.重定向</h1><h2 id="请求类型"><a href="#请求类型" class="headerlink" title="请求类型"></a><strong>请求类型</strong></h2><ul>
<li><p><strong>Request</strong> 对象提供了一个方法 <strong>method()</strong> 来获取当前请求类型，也提供了判断当前的请求类型：</p>
<table>
<thead>
<tr>
<th align="center">方法</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">method</td>
<td align="left">获取当前请求类型</td>
</tr>
<tr>
<td align="center">isGet</td>
<td align="left">判断是否GET请求</td>
</tr>
<tr>
<td align="center">isPost</td>
<td align="left">判断是否POST请求</td>
</tr>
<tr>
<td align="center">isPut</td>
<td align="left">判断是否PUT请求</td>
</tr>
<tr>
<td align="center">isDelete</td>
<td align="left">判断是否DELETE请求</td>
</tr>
<tr>
<td align="center">isAjax</td>
<td align="left">判断是否AJAX请求</td>
</tr>
</tbody></table>
</li>
<li><p>使用请求类型伪装，可以提交 PUT、DELETE 类型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 载入表单模板</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">View</span>::<span class="title function_ invoke__">engine</span>(<span class="string">&quot;php&quot;</span>)-&gt;<span class="title function_ invoke__">fetch</span>(<span class="string">&quot;create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 表单</span></span><br><span class="line">&lt;form action=<span class="string">&quot;/rely&quot;</span> method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;name&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;_method&quot;</span> value=<span class="string">&quot;PUT&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;提交&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">   </span><br><span class="line"><span class="comment">// 判断是否PUT请求</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">isPut</span>()) &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="title function_ invoke__">input</span>(<span class="string">&quot;put.name&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接ajax、pjax伪装，在url后续添加?_ajax=1即可，结合前段时再研究</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="响应输出"><a href="#响应输出" class="headerlink" title="响应输出"></a><strong>响应输出</strong></h2><ul>
<li><p>响应输出，有好几种：包括 <strong>return</strong>、<strong>json()</strong> 和 <strong>view()</strong> 等等；</p>
</li>
<li><p>默认输出方式是以 html 格式输出，如果你发起 json 请求，则输出 json；</p>
</li>
<li><p>而背后是 response 对象，可以用 <strong>response()</strong> 输出达到相同的效果；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$data</span> = <span class="string">&quot;Hello,TP8!&quot;</span>;</span><br><span class="line"><span class="comment">// 等同于 return $data;</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">response</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>response()方法可以设置第二参数，状态码，或调用 code()方法；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数二，发送状态码</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">response</span>(<span class="variable">$data</span>, <span class="number">201</span>);</span><br><span class="line"><span class="comment">//或</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">response</span>(<span class="variable">$data</span>)-&gt;<span class="title function_ invoke__">code</span>(<span class="number">201</span>);</span><br><span class="line"><span class="comment">// json()和view()均支持状态码</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a><strong>重定向</strong></h2><ul>
<li><p>使用 redirect()方法可以实现页面重定向，需要 return 执行；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首页</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="comment">// 访问路由页面，外加状态码</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="string">&quot;details/5&quot;</span>, <span class="number">303</span>);</span><br><span class="line"><span class="comment">// 访问url生成的地址</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url</span>(<span class="string">&quot;Index/index&quot;</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>还支持session跳转和记住上一次地址的跳转，实战时再研究；</p>
</li>
</ul>
<h1 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h1><h2 id="定义-3"><a href="#定义-3" class="headerlink" title="定义"></a>定义</h2><h3 id="定义中间件"><a href="#定义中间件" class="headerlink" title="定义中间件"></a><strong>定义中间件</strong></h3><ul>
<li><p>中间件的主要用于拦截和过滤 HTTP 请求，并进行相应处理；</p>
</li>
<li><p>这些请求的功能可以是 URL 重定向、权限验证等等；</p>
</li>
<li><p>为了进一步了解中间件的用法，我们首先定义一个基础的中间件；</p>
</li>
<li><p>可以通过命令行模式，在应用目录下生成一个中间件文件和文件夹；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think make:middleware Check</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span>, \<span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 拦截请求</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">param</span>(<span class="string">&quot;name&quot;</span>) == <span class="string">&quot;index&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="string">&quot;../../../../&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 继续往执行</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$request</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后将这个中间件进行注册，在应用目录下的middleware.php文件中配置；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册中间件</span></span><br><span class="line">app\middleware<span class="title class_">\Check</span>::<span class="variable language_">class</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>中间件的入口执行方法必须是：handle()方法，第一参数请求，第二参数是闭包；</p>
</li>
<li><p>业务代码判断请求的 name 如果等于 index，就拦截住，执行中间件，跳转到首页；</p>
</li>
<li><p>但如果请求的 name 是 lee，那需要继续往下执行才行，不能被拦死；</p>
</li>
<li><p>那么就需要$next($request)把这个请求去调用回调函数；</p>
</li>
<li><p>中间件 handle()方法规定需要返回 response 对象，才能正常使用；</p>
</li>
<li><p>而$next($request)执行后，就是返回的 response 对象；</p>
</li>
<li><p>为了测试拦截后，无法继续执行，可以 return response()助手函数测试；</p>
</li>
</ul>
<h3 id="前后置中间件"><a href="#前后置中间件" class="headerlink" title="前后置中间件"></a><strong>前后置中间件</strong></h3><ul>
<li><p>将$next($request)放在方法底部的方式，属于前置中间件；</p>
</li>
<li><p>前置中间件就是请求阶段来进行拦截验证，比如登录判断、跳转、权限等；</p>
</li>
<li><p>而后置中间件就是请求完毕之后再进行验证，比如写入日志等等；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span>, \<span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//中间件代码，前置</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$request</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span>, \<span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$response</span> = <span class="variable">$next</span>(<span class="variable">$request</span>);</span><br><span class="line">    <span class="comment">//中间件代码，后置</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先执行内容，再执行中间件</span></span><br><span class="line"><span class="variable">$response</span> = <span class="variable">$next</span>(<span class="variable">$request</span>);</span><br><span class="line"><span class="comment">// 拦截请求</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">param</span>(<span class="string">&quot;name&quot;</span>) == <span class="string">&quot;index&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="string">&quot;../../../../&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$response</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="中间件操作"><a href="#中间件操作" class="headerlink" title="中间件操作"></a>中间件操作</h2><h3 id="路由中间件"><a href="#路由中间件" class="headerlink" title="路由中间件"></a><strong>路由中间件</strong></h3><ul>
<li><p>创建一个给路由使用的中间件，判断路由的 ID 值实现相应的验证；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think make:middleware Auth</span><br></pre></td></tr></table></figure>
</li>
<li><p>路由方法提供了一个 <strong>middleware()</strong> 方法，让指定的路由采用指定的中间件；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 限定这个路由采用了中间件</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;Index/index&#x27;</span>)-&gt;<span class="title function_ invoke__">middleware</span>(\app\middleware<span class="title class_">\Auth</span>::<span class="variable language_">class</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入后，可以省略</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">middleware</span>\<span class="title">Auth</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">middleware</span>\<span class="title">Check</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由采用多个中间件</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;Index/index&#x27;</span>)-&gt;<span class="title function_ invoke__">middleware</span>([<span class="title class_">Auth</span>::<span class="variable language_">class</span>, <span class="title class_">Check</span>::<span class="variable language_">class</span>]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>也可以在 config&#x2F;middleware.php 配置文件加中，配置别名支持；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 别名或分组</span></span><br><span class="line"><span class="string">&#x27;alias&#x27;</span>    =&gt; [</span><br><span class="line">    <span class="string">&quot;Auth&quot;</span>  =&gt; \app\middleware<span class="title class_">\Auth</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="string">&quot;Check&quot;</span> =&gt; \app\middleware<span class="title class_">\Check</span>::<span class="variable language_">class</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当然，Route::group() 路由分组也支持</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">rule</span>(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;Index/index&#x27;</span>)-&gt;<span class="title function_ invoke__">middleware</span>([<span class="string">&quot;Auth&quot;</span>, <span class="string">&quot;Check&quot;</span>]);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-控制器中间件"><a href="#2-控制器中间件" class="headerlink" title="2. 控制器中间件"></a>2. <strong>控制器中间件</strong></h3><ul>
<li><p>如果不用路由，怎么用局部化的中间件呢？当然也可以直接在控制器上定义；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里是别名方式，和路由一样，另外两种均支持</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$middleware</span> = [<span class="string">&quot;Auth&quot;</span>, <span class="string">&quot;Check&quot;</span>];</span><br></pre></td></tr></table></figure>
</li>
<li><p>默认是控制器全体方法有效，如果需要限制，还是 <strong>only</strong> 和 <strong>except</strong>；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$middleware</span> = [</span><br><span class="line">    <span class="string">&quot;Auth&quot;</span>  =&gt;  [<span class="string">&quot;only&quot;</span> =&gt;  [<span class="string">&quot;hello&quot;</span>]],</span><br><span class="line">    <span class="string">&quot;Check&quot;</span> =&gt;  [<span class="string">&quot;only&quot;</span> =&gt;  [<span class="string">&quot;index&quot;</span>]]</span><br><span class="line">];</span><br></pre></td></tr></table></figure></li>
</ul>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Sherlock.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Sherlock.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">Sherlock</div><div class="post-copyright__author_desc">言念君子，温其如玉</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2024/07/14/thinkphp%E5%AD%A6%E4%B9%A0/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2024/07/14/thinkphp%E5%AD%A6%E4%B9%A0/')">thinkphp学习</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2024/07/14/thinkphp%E5%AD%A6%E4%B9%A0/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=thinkphp学习&amp;url=http://example.com/2024/07/14/thinkphp%E5%AD%A6%E4%B9%A0/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/php/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>php<span class="tagsPageCount">5</span></a></div></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/10/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9ACVE-2023-1773/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">代码审计：CVE-2023-1773</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/25/imaginaryctf-writeup/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">imaginaryctf-writeup</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2024/05/25/PHP%E4%B8%AD%E5%87%BA%E7%8E%B0Call-to-undefined-function-mysqli-connect/" title="PHP中出现Call to undefined function mysqli_connect()"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-25</div><div class="title">PHP中出现Call to undefined function mysqli_connect()</div></div></a></div><div><a href="/2024/02/27/php%E7%89%B9%E6%80%A7/" title="php特性"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-27</div><div class="title">php特性</div></div></a></div><div><a href="/2023/10/28/php/php/" title="php"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-28</div><div class="title">php</div></div></a></div><div><a href="/2024/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0_max/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/" title="php反序列化学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-16</div><div class="title">php反序列化学习</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Sherlock.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" ait="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这里是我<b style="color:#fff">记录学习</b>收获的个人博客，<b style="color:#fff">也希望</b>能和大家一起<b style="color:#fff">进步</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">愿你可以在这里找到对你有<b style="color:#fff">帮助</b>的<b style="color:#fff">文章</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Sherlock</h1><div class="author-info__desc">言念君子，温其如玉</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/cina666" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>Announcement</span></div><div class="announcement_content">欢迎来看我的博客鸭~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%95%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">引用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85thinphp8-0"><span class="toc-number">2.</span> <span class="toc-text">安装thinphp8.0</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80"><span class="toc-number">3.</span> <span class="toc-text">基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.</span> <span class="toc-text">目录结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E5%BA%94%E7%94%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.1.</span> <span class="toc-text">单应用模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%BA%94%E7%94%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.2.</span> <span class="toc-text">多应用模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E5%BA%94%E7%94%A8%E6%96%87%E4%BB%B6"><span class="toc-number">3.1.3.</span> <span class="toc-text">默认应用文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.4.</span> <span class="toc-text">配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">4.</span> <span class="toc-text">架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B"><span class="toc-number">4.1.</span> <span class="toc-text">HTTP请求流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6"><span class="toc-number">4.2.</span> <span class="toc-text">入口文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6"><span class="toc-number">4.2.1.</span> <span class="toc-text">应用入口文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6"><span class="toc-number">4.2.2.</span> <span class="toc-text">控制台入口文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E5%BA%94%E7%94%A8%E6%A8%A1%E5%BC%8F-1"><span class="toc-number">4.3.</span> <span class="toc-text">多应用模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#URL%E8%AE%BF%E9%97%AE"><span class="toc-number">4.4.</span> <span class="toc-text">URL访问</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E5%BA%94%E7%94%A8URL"><span class="toc-number">4.4.1.</span> <span class="toc-text">单应用URL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#URL%E9%87%8D%E5%86%99"><span class="toc-number">4.4.2.</span> <span class="toc-text">URL重写</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Apache"><span class="toc-number">4.4.2.1.</span> <span class="toc-text">[ Apache ]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx"><span class="toc-number">4.4.2.2.</span> <span class="toc-text">[ Nginx ]</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">5.</span> <span class="toc-text">控制器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-number">5.1.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%92%8C%E7%A9%BA%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">5.2.</span> <span class="toc-text">基础和空控制器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">5.2.1.</span> <span class="toc-text">基础控制器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A9%BA%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">5.2.2.</span> <span class="toc-text">空控制器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">6.</span> <span class="toc-text">数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8F%8A%E8%A1%A8"><span class="toc-number">6.1.</span> <span class="toc-text">创建数据库及表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.2.</span> <span class="toc-text">连接数据库和查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">6.2.1.</span> <span class="toc-text">连接数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="toc-number">6.2.2.</span> <span class="toc-text">PHP获取数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.3.</span> <span class="toc-text">数据查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#table%E6%96%B9%E6%B3%95"><span class="toc-number">6.3.1.</span> <span class="toc-text">table方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E5%BC%8F%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.3.2.</span> <span class="toc-text">链式查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.3.3.</span> <span class="toc-text">表达式查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%A4%BA%E4%BE%8B"><span class="toc-number">6.3.3.1.</span> <span class="toc-text">查询示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E5%89%8D%E7%BC%80%E4%B9%8B%E6%89%A9%E5%B1%95%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.4.</span> <span class="toc-text">表前缀之扩展查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E5%89%8D%E7%BC%80"><span class="toc-number">6.4.1.</span> <span class="toc-text">表前缀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.4.2.</span> <span class="toc-text">扩展查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%95%B0%E6%8D%AE"><span class="toc-number">6.5.</span> <span class="toc-text">添加数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E6%9D%A1%E6%96%B0%E5%A2%9E"><span class="toc-number">6.5.1.</span> <span class="toc-text">单条新增</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%9D%A1%E6%96%B0%E5%A2%9E"><span class="toc-number">6.5.2.</span> <span class="toc-text">多条新增</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%EF%BC%8C%E5%88%A0%E9%99%A4%E4%BB%A5%E5%8F%8Asave%E6%96%B9%E6%B3%95"><span class="toc-number">6.6.</span> <span class="toc-text">更新，删除以及save方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%BF%AE%E6%94%B9"><span class="toc-number">6.6.1.</span> <span class="toc-text">数据修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%88%A0%E9%99%A4"><span class="toc-number">6.6.2.</span> <span class="toc-text">数据删除</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%90%84%E7%A7%8D%E6%9F%A5%E8%AF%A2%E6%96%B9%E5%BC%8F"><span class="toc-number">6.7.</span> <span class="toc-text">其他各种查询方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9D%A1%E4%BB%B6"><span class="toc-number">6.7.1.</span> <span class="toc-text">字符串条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#field-%E5%AD%97%E6%AE%B5%E7%AD%9B%E9%80%89"><span class="toc-number">6.7.2.</span> <span class="toc-text">field()字段筛选</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E9%93%BE%E5%BC%8F%E6%96%B9%E6%B3%95"><span class="toc-number">6.7.3.</span> <span class="toc-text">常用链式方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.7.4.</span> <span class="toc-text">时间查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.7.5.</span> <span class="toc-text">聚合查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.7.6.</span> <span class="toc-text">子查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.7.7.</span> <span class="toc-text">原生查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%97%E5%AD%97%E6%AE%B5%E5%BF%AB%E6%8D%B7%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.7.8.</span> <span class="toc-text">列字段快捷查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.7.9.</span> <span class="toc-text">条件查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">6.7.10.</span> <span class="toc-text">事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%99%A8"><span class="toc-number">6.7.11.</span> <span class="toc-text">获取器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.8.</span> <span class="toc-text">高级查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%85%B3%E8%81%94"><span class="toc-number">6.8.1.</span> <span class="toc-text">索引关联</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%BC%E8%A3%85%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.8.2.</span> <span class="toc-text">拼装查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B"><span class="toc-number">7.</span> <span class="toc-text">模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89-1"><span class="toc-number">7.1.</span> <span class="toc-text">定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9E%8B"><span class="toc-number">7.1.1.</span> <span class="toc-text">定义模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E8%AE%BE%E7%BD%AE"><span class="toc-number">7.1.2.</span> <span class="toc-text">模型设置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E5%92%8C%E5%88%A0%E9%99%A4"><span class="toc-number">7.2.</span> <span class="toc-text">新增和删除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E6%93%8D%E4%BD%9C"><span class="toc-number">7.2.1.</span> <span class="toc-text">新增操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%93%8D%E4%BD%9C"><span class="toc-number">7.2.2.</span> <span class="toc-text">删除操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0"><span class="toc-number">7.3.</span> <span class="toc-text">更新</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0"><span class="toc-number">7.3.1.</span> <span class="toc-text">数据更新</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2"><span class="toc-number">7.4.</span> <span class="toc-text">查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E7%9A%84%E6%9F%A5%E8%AF%A2"><span class="toc-number">7.4.1.</span> <span class="toc-text">模型的查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%AD%97%E6%AE%B5%E8%AE%BE%E7%BD%AE"><span class="toc-number">7.5.</span> <span class="toc-text">模型的字段设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E8%AE%BE%E7%BD%AE"><span class="toc-number">7.5.1.</span> <span class="toc-text">字段设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%9F%E5%BC%83%E5%AD%97%E6%AE%B5"><span class="toc-number">7.5.2.</span> <span class="toc-text">废弃字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AA%E8%AF%BB%E5%AD%97%E6%AE%B5"><span class="toc-number">7.5.3.</span> <span class="toc-text">只读字段</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%99%A8%E5%92%8C%E4%BF%AE%E6%94%B9%E5%99%A8"><span class="toc-number">7.6.</span> <span class="toc-text">获取器和修改器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%99%A8-1"><span class="toc-number">7.6.1.</span> <span class="toc-text">获取器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%99%A8"><span class="toc-number">7.6.2.</span> <span class="toc-text">修改器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E5%99%A8%E5%92%8C%E8%87%AA%E5%8A%A8%E6%97%B6%E9%97%B4%E6%88%B3"><span class="toc-number">7.7.</span> <span class="toc-text">搜索器和自动时间戳</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E5%99%A8"><span class="toc-number">7.7.1.</span> <span class="toc-text">搜索器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%97%B6%E9%97%B4%E6%88%B3"><span class="toc-number">7.7.2.</span> <span class="toc-text">自动时间戳</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E5%88%A0%E9%99%A4%E5%92%8C%E4%BA%8B%E4%BB%B6"><span class="toc-number">7.8.</span> <span class="toc-text">软删除和事件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AF%E5%88%A0%E9%99%A4"><span class="toc-number">7.8.1.</span> <span class="toc-text">软删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6"><span class="toc-number">7.8.2.</span> <span class="toc-text">事件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E4%BA%8B%E4%BB%B6%E5%AE%9A%E4%B9%89"><span class="toc-number">7.8.2.1.</span> <span class="toc-text">模型事件定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E4%BA%8B%E4%BB%B6"><span class="toc-number">7.8.2.2.</span> <span class="toc-text">写入事件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E6%A8%A1%E5%9E%8B"><span class="toc-number">8.</span> <span class="toc-text">关联模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8"><span class="toc-number">8.1.</span> <span class="toc-text">入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E8%A1%A8"><span class="toc-number">8.1.1.</span> <span class="toc-text">关联表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.1.2.</span> <span class="toc-text">关联查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.2.</span> <span class="toc-text">一对一关联查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hasOne-%E6%A8%A1%E5%BC%8F"><span class="toc-number">8.2.1.</span> <span class="toc-text">hasOne 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#belongsTo-%E6%A8%A1%E5%BC%8F"><span class="toc-number">8.2.2.</span> <span class="toc-text">belongsTo 模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.3.</span> <span class="toc-text">一对多关联查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hasMany-%E6%A8%A1%E5%BC%8F"><span class="toc-number">8.3.1.</span> <span class="toc-text">hasMany 模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E9%A2%84%E8%BD%BD%E5%85%A5%E5%92%8C%E7%BB%9F%E8%AE%A1"><span class="toc-number">8.4.</span> <span class="toc-text">模型预载入和统计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E8%BD%BD%E5%85%A5"><span class="toc-number">8.4.1.</span> <span class="toc-text">预载入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E7%BB%9F%E8%AE%A1"><span class="toc-number">8.4.2.</span> <span class="toc-text">关联统计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.5.</span> <span class="toc-text">多对多关联查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E4%B8%89%E5%BC%A0%E8%A1%A8"><span class="toc-number">8.5.1.</span> <span class="toc-text">建立三张表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="toc-number">8.5.2.</span> <span class="toc-text">权限控制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1"><span class="toc-number">9.</span> <span class="toc-text">路由</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89-2"><span class="toc-number">9.1.</span> <span class="toc-text">定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%85%A5%E9%97%A8"><span class="toc-number">9.1.1.</span> <span class="toc-text">路由入门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%BA%E5%88%B6%E8%B7%AF%E7%94%B1"><span class="toc-number">9.1.2.</span> <span class="toc-text">强制路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E5%85%A8%E5%8C%B9%E9%85%8D"><span class="toc-number">9.1.3.</span> <span class="toc-text">完全匹配</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E9%97%AD%E5%8C%85%E5%92%8C%E5%8F%98%E9%87%8F%E8%A7%84%E5%88%99"><span class="toc-number">9.2.</span> <span class="toc-text">路由闭包和变量规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AD%E5%8C%85"><span class="toc-number">9.2.1.</span> <span class="toc-text">闭包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E8%A7%84%E5%88%99"><span class="toc-number">9.2.2.</span> <span class="toc-text">变量规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%8F%82%E6%95%B0-%E5%9F%9F%E5%90%8D-MISS"><span class="toc-number">9.3.</span> <span class="toc-text">路由参数.域名.MISS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0"><span class="toc-number">9.3.1.</span> <span class="toc-text">参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D"><span class="toc-number">9.3.2.</span> <span class="toc-text">域名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MISS"><span class="toc-number">9.3.3.</span> <span class="toc-text">MISS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%88%86%E7%BB%84-URL%E7%94%9F%E6%88%90"><span class="toc-number">9.4.</span> <span class="toc-text">路由分组.URL生成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%BB%84"><span class="toc-number">9.4.1.</span> <span class="toc-text">分组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#URL%E7%94%9F%E6%88%90"><span class="toc-number">9.4.2.</span> <span class="toc-text">URL生成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E8%B7%AF%E7%94%B1"><span class="toc-number">9.5.</span> <span class="toc-text">资源路由</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90"><span class="toc-number">9.5.1.</span> <span class="toc-text">创建资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80URL"><span class="toc-number">9.5.2.</span> <span class="toc-text">地址URL</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE-%E5%8F%98%E9%87%8F-%E6%B8%B2%E6%9F%93"><span class="toc-number">10.</span> <span class="toc-text">视图.变量,渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E6%93%8D%E4%BD%9C"><span class="toc-number">10.1.</span> <span class="toc-text">视图操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E6%8F%90%E4%BA%A4"><span class="toc-number">10.2.</span> <span class="toc-text">表单提交</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%AF%B9%E8%B1%A1-%E5%8F%98%E9%87%8F-%E4%BF%A1%E6%81%AF"><span class="toc-number">11.</span> <span class="toc-text">请求对象.变量.信息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%AF%B9%E8%B1%A1"><span class="toc-number">11.1.</span> <span class="toc-text">请求对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E4%BF%A1%E6%81%AF"><span class="toc-number">11.2.</span> <span class="toc-text">请求信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%8F%98%E9%87%8F"><span class="toc-number">11.3.</span> <span class="toc-text">请求变量</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E7%B1%BB%E5%9E%8B-%E8%BE%93%E5%87%BA-%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">12.</span> <span class="toc-text">请求类型.输出.重定向</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E7%B1%BB%E5%9E%8B"><span class="toc-number">12.1.</span> <span class="toc-text">请求类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E8%BE%93%E5%87%BA"><span class="toc-number">12.2.</span> <span class="toc-text">响应输出</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">12.3.</span> <span class="toc-text">重定向</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">13.</span> <span class="toc-text">中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89-3"><span class="toc-number">13.1.</span> <span class="toc-text">定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">13.1.1.</span> <span class="toc-text">定义中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%BD%AE%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">13.1.2.</span> <span class="toc-text">前后置中间件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">13.2.</span> <span class="toc-text">中间件操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">13.2.1.</span> <span class="toc-text">路由中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">13.2.2.</span> <span class="toc-text">2. 控制器中间件</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/20/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-initial/" title="春秋云镜-initial">春秋云镜-initial</a><time datetime="2025-08-20T08:11:22.000Z" title="Created 2025-08-20 16:11:22">2025-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/15/linux-webshell%E6%8F%90%E6%9D%83/" title="linux webshell提权">linux webshell提权</a><time datetime="2025-08-15T08:12:42.000Z" title="Created 2025-08-15 16:12:42">2025-08-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/15/%E5%8F%8D%E5%BC%B9shell%E5%8D%87%E7%BA%A7%E4%B8%BA%E5%AE%8C%E5%85%A8%E4%BA%A4%E4%BA%92%E5%BC%8Fshell/" title="反弹shell升级为完全交互式shell">反弹shell升级为完全交互式shell</a><time datetime="2025-08-15T02:58:47.000Z" title="Created 2025-08-15 10:58:47">2025-08-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-jshERP-3-5/" title="代码审计-jshERP-3.5">代码审计-jshERP-3.5</a><time datetime="2025-08-01T07:56:41.000Z" title="Created 2025-08-01 15:56:41">2025-08-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/20/CTF-java%E4%B8%93%E9%A2%98/" title="CTF-java专题">CTF-java专题</a><time datetime="2025-07-20T12:14:58.000Z" title="Created 2025-07-20 20:14:58">2025-07-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-上班摸鱼中.svg" alt="距离月入25k也就还差一个大佬带我~" title="距离月入25k也就还差一个大佬带我~"/><div id="runtimeTextTip"></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 - 2025 By <a class="footer-bar-link" href="/" title="Sherlock" target="_blank">Sherlock</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">Articles</div><div class="length-num">79</div></a><a href="/tags/" title="tag"><div class="headline">Tags</div><div class="length-num">10</div></a><a href="/categories/" title="category"><div class="headline">Categories</div><div class="length-num">10</div></a></div><span class="sidebar-menu-item-title">Function</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="Display Mode"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>Display Mode</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/essay/"><span> 闲言碎语</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/cors/" style="font-size: 0.88rem;">cors<sup>1</sup></a><a href="/tags/csrf/" style="font-size: 0.88rem;">csrf<sup>1</sup></a><a href="/tags/php/" style="font-size: 0.88rem;">php<sup>5</sup></a><a href="/tags/python/" style="font-size: 0.88rem;">python<sup>3</sup></a><a href="/tags/sql/" style="font-size: 0.88rem;">sql<sup>3</sup></a><a href="/tags/ssrf/" style="font-size: 0.88rem;">ssrf<sup>1</sup></a><a href="/tags/ssti/" style="font-size: 0.88rem;">ssti<sup>2</sup></a><a href="/tags/web/" style="font-size: 0.88rem;">web<sup>3</sup></a><a href="/tags/xss/" style="font-size: 0.88rem;">xss<sup>1</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 0.88rem;">前端<sup>2</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.4/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("10/04/2023 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2023 By 安知鱼 V1.6.8",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Sherlock 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("10/04/2023 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      img.src = "https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-下班啦.svg";
      img.title = "下班了就该开开心心的玩耍，嘿嘿~";
      img.alt = "下班了就该开开心心的玩耍，嘿嘿~";

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "visitor@anheyu.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>